/* ***** BEGIN LICENSE BLOCK *****
 * Version: MPL 1.1/GPL 2.0/LGPL 2.1
 *
 * The contents of this file are subject to the Mozilla Public License Version
 * 1.1 (the "License"); you may not use this file except in compliance with
 * the License. You may obtain a copy of the License at
 * http://www.mozilla.org/MPL/
 *
 * Software distributed under the License is distributed on an "AS IS" basis,
 * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
 * for the specific language governing rights and limitations under the
 * License.
 *
 * The Original Code is Old School RPG Map.
 *
 * The Initial Developer of the Original Code is Jono Xia.
 * Portions created by the Initial Developer are Copyright (C) 2007
 * the Initial Developer. All Rights Reserved.
 *
 * Contributor(s):
 *   Jono Xia <jono@mozilla.com>
 *   Gaurav Munjal <Gaurav0@aol.com>
 *   Jebb Burditt <jebb.burditt@gmail.com>
 *   David Leonard <sephirothcloud1025@yahoo.com>
 *
 * Alternatively, the contents of this file may be used under the terms of
 * either the GNU General Public License Version 2 or later (the "GPL"), or
 * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
 * in which case the provisions of the GPL or the LGPL are applicable instead
 * of those above. If you wish to allow use of your version of this file only
 * under the terms of either the GPL or the LGPL, and not to allow others to
 * use your version of this file under the terms of the MPL, indicate your
 * decision by deleting the provisions above and replace them with the notice
 * and other provisions required by the GPL or the LGPL. If you do not delete
 * the provisions above, a recipient may use your version of this file under
 * the terms of any one of the MPL, the GPL or the LGPL.
 *
 * ***** END LICENSE BLOCK ***** */
 function mn(e,t){$.ajax({type:"GET",url:e,dataType:"xml",async:!1,success:t,error:function(e,t,n){alert("error:"+t)}})}function gn(){for(var e in Bn.images){var t=Bn.images[e],n=t.url,r=new Image;t.img=r,dn.addResource(n,r),r.onload=function(e,t){return function(){dn.setLoaded(t),!e.load||e.load()}}(t,n),r.src=n}}function yn(){var e=0,t=Object.keys(Qn.submaps).length;for(var n=0;n<t;++n){var r=Qn.submaps[n],i=r.id,u=new m(r.tileset.width,r.tileset.height,r.tileset.imgRef),f=r.xmlUrl;dn.addResource(f),mn(f,function(n,r,i,u){return function(f){dn.setLoaded(u);var l=null;r==0?(un=new o(f,i),l=un.getSubMap(0)):(l=new s(f,i,n.overWorld),un.addSubMap(r,l)),!n.load||n.load();var c=n.zone;if(n.randomEncounters)for(var h=0;h<l.getXLimit();++h)for(var d=0;d<l.getYLimit();++d){var v=l.getSquareAt(h,d);v.passable()&&(v.onEnter=function(){if(Math.random()<Jt){An=0,hn=new Pt;var e=this.getZone();e||(e=c),hn.setupRandomEncounter(e,n.background),hn.draw()}})}var m=un.getSubMap(r);if(n.entrances)for(var g=0;g<n.entrances.length;++g){var y=n.entrances[g],v=m.getSquareAt(y.fromX,y.fromY);v.onEnter=function(e){return function(){un.goToMap(on,e.toMapId,e.toX,e.toY,e.toScrollX,e.toScrollY,e.facing),!e.onEnter||e.onEnter()}}(y)}if(n.exit){function b(){un.goToMap(on,n.exit.toMapId,n.exit.toX,n.exit.toY,n.exit.toScrollX,n.exit.toScrollY,n.exit.facing)}var w=l.getXLimit(),E=l.getYLimit();if(n.exit.at=="edges"){for(var h=0;h<w;h++)for(var d=0;d<E;d++)if(h==0||d==0||h==w-1||d==E-1)m.getSquareAt(h,d).onEnter=b}else if(n.exit.at=="bottom"){var d=E-1;for(var h=0;h<w;h++)m.getSquareAt(h,d).onEnter=b}else if(n.exit.at=="top"){var d=0;for(var h=0;h<w;h++)m.getSquareAt(h,d).onEnter=b}else if(n.exit.at=="left"){var h=0;for(var d=0;d<E;d++)m.getSquareAt(h,d).onEnter=b}else if(n.exit.at=="right"){var h=w-1;for(var d=0;d<E;d++)m.getSquareAt(h,d).onEnter=b}}if(n.npcs)for(var g=0;g<n.npcs.length;++g){var S=n.npcs[g],x=new p(S.locX,S.locY,S.imgRef,r,S.facing,S.walks);x.action=function(e){return function(){this.facePlayer(),!e.callback||fn.setCallback(e.callback),fn.displayText(e.displayText)}}(S),l.addSprite(x),S.npc=x}if(n.actions)for(var g=0;g<n.actions.length;++g){var T=n.actions[g],v=m.getSquareAt(T.locX,T.locY);v.onAction=function(e){return function(){(!e.dir||e.dir==on.getDir())&&e.onAction()}}(T)}if(n.chests)for(var g=0;g<n.chests.length;++g){var N=n.chests[g],C=new a(N.locX,N.locY,N.imgRef,r,N.event);C.action=N.action,l.addSprite(C)}++e==t&&dn.finishSetup()}}(r,i,u,f))}}function bn(e){hn?hn.writeMsg(e):fn.displayText(e)}function wn(e,t,n,r,i,s,o){e.lineWidth=o,e.strokeStyle="white";var u=t+2*o,a=n+2*o,f=t+r-2*o,l=n+i-2*o;e.beginPath(),e.moveTo(u+s,a),e.lineTo(f-s,a),e.quadraticCurveTo(f,a,f,a+s),e.lineTo(f,l-s),e.quadraticCurveTo(f,l,f-s,l),e.lineTo(u+s,l),e.quadraticCurveTo(u,l,u,l-s),e.lineTo(u,a+s),e.quadraticCurveTo(u,a,u+s,a),e.closePath(),e.shadowOffsetX=o/2,e.shadowOffsetY=o/2,e.shadowBlur=o,e.shadowColor="rgba(0, 0, 0, 0.5)";var c=e.createLinearGradient(t,n,t,n+i);c.addColorStop(0,"#0066FF"),c.addColorStop(1,"#000099"),e.fillStyle=c,e.fill(),e.stroke(),e.shadowOffsetX=0,e.shadowOffsetY=0,e.shadowBlur=0,e.shadowColor="transparent"}function En(e){ln.setOnNewGame(e)}function Mn(e){if(!e.ctrlKey&&!e.altKey&&!e.metaKey){var t=e.keyCode?e.keyCode:e.charCode?e.charCode:0;On=!0,Dn(t,e)}}function _n(){On=!1,hn&&hn.handleKeyUp()}function Dn(e,t){if(dn.isLoadComplete())if(un.isAnimating())An=e,t.preventDefault();else switch(e){case Sn:ln.isDisplayed()?ln.handleKey(e):cn.shopDisplayed()?cn.handleKey(e):hn?hn.handleKey(e):!an&&!fn.textDisplayed()&&!un.isAnimating()&&on.move(0,1,c),t.preventDefault();break;case xn:ln.isDisplayed()?ln.handleKey(e):cn.shopDisplayed()?cn.handleKey(e):hn?hn.handleKey(e):!an&&!fn.textDisplayed()&&!un.isAnimating()&&on.move(0,-1,f),t.preventDefault();break;case Nn:ln.isDisplayed()?ln.handleKey(e):cn.shopDisplayed()?cn.handleKey(e):hn?hn.handleKey(e):!an&&!fn.textDisplayed()&&!un.isAnimating()&&on.move(1,0,l),t.preventDefault();break;case Tn:ln.isDisplayed()?ln.handleKey(e):cn.shopDisplayed()?cn.handleKey(e):hn?hn.handleKey(e):!an&&!fn.textDisplayed()&&!un.isAnimating()&&on.move(-1,0,h),t.preventDefault();break;case Cn:case kn:fn.textDisplayed()?fn.clearText():ln.isDisplayed()?ln.handleEnter():cn.shopDisplayed()?cn.handleEnter():hn?hn.handleEnter():un.isAnimating()||(un.doAction(),on.getSquareUnderfoot().onAction()),t.preventDefault();break;case Ln:fn.textDisplayed()?fn.clearText():ln.isDisplayed()?ln.handleESC():cn.shopDisplayed()?cn.handleESC():hn?hn.handleESC():ln.getCurrentMenu().display(),t.preventDefault()}}function Pn(){if(An&&!hn&&!un.isAnimating()){var e=An;An=0;switch(e){case Sn:on.move(0,1,c);break;case xn:on.move(0,-1,f);break;case Nn:on.move(1,0,l);break;case Tn:on.move(-1,0,h);break;case Cn:case kn:fn.textDisplayed()?fn.clearText():un.doAction()}}}function Hn(){if(pn){var e=window.innerWidth,t=window.innerHeight,n=e/Qt.width,r=t/Qt.height,i=n>r?r:n,s=0,o=0;n<r?s=(t-Qt.height)/2:o=(e-Qt.width)/2;for(var u=0;u<vn.length;++u){var a=vn[u];n<r?(a.style.MozTransformOrigin="center left",a.style.WebkitTransformOrigin="center left",a.style.OTransformOrigin="center left",a.style.msTransformOrigin="center left"):(a.style.MozTransformOrigin="top center",a.style.WebkitTransformOrigin="top center",a.style.OTransformOrigin="top center",a.style.msTransformOrigin="top center"),a.style.left=Math.floor(o)+"px",a.style.top=Math.floor(s)+"px",a.style.MozTransform="scale("+i+")",a.style.WebkitTransform="scale("+i+")",a.style.OTransform="scale("+i+")",a.style.msTransform="scale("+i+")",a.style.zIndex=1}}else for(var u=0;u<vn.length;++u){var a=vn[u];a.style.MozTransform="",a.style.WebkitTransform="",a.style.OTransform="",a.style.msTransform="",a.style.left="10px",a.style.top="120px",a.style.zIndex=0}}var e=Class.extend({_init:function(){this._lastFrameTime=Date.now()},getDelay:function(){var e=Date.now(),t=e-this._lastFrameTime,n=1e3/Vt-t;return n<1&&(n=1),n},update:function(){this._lastFrameTime=Date.now()}}),t=1e4,n=Class.extend({_init:function(){this._resources={},this._count=0,this._loaded=0,this._setupFinished=!1;var e=this;this._failTimeout=window.setTimeout(function(){e.onFail()},t)},addResource:function(e,t){this._resources[e]=new r(e,t),this._count++},finishSetup:function(){this._setupFinished=!0,this.isLoadComplete()&&(window.clearTimeout(this._failTimeout),this.onComplete())},setLoaded:function(e){this._resources[e].setLoaded(),this._loaded++,this.isLoadComplete()&&(window.clearTimeout(this._failTimeout),this.onComplete())},isLoadComplete:function(){return this._setupFinished&&this._count==this._loaded},getPercentLoaded:function(){return this._loaded/this._count},getList:function(){var e=[];for(res in this._resources)this._resources[res].isLoaded()||e.push(res);return e},onComplete:function(){},onFail:function(){}}),r=Class.extend({_init:function(e,t){this._url=e,this._res=t,this._loaded=!1},isLoaded:function(){return this._loaded},setLoaded:function(){this._loaded=!0}}),i=Class.extend({_init:function(e,t,n,r,i){this._subMap=e,this._x=t,this._y=n,this._passable=r,this._zone=i},getX:function(){return this._x},getY:function(){return this._y},passable:function(){return this._passable},getZone:function(){return this._zone},onEnter:function(e){},onAction:function(e){}}),s=Class.extend({_init:function(t,n,r){this._layer=$(t).find("map layer").eq(0),this._xLimit=parseInt($(this._layer).attr("width")),this._yLimit=parseInt($(this._layer).attr("height")),this._mapXml=t,this._tileset=n,this._overworld=r,this._spriteList=[],this._mapSquares=[],this._animation=new e;var s=null;$(t).find('layer[name="Water"]').length>0&&(s=$(t).find('layer[name="Water"]').find("tile"));var o=$(t).find('layer[name="Base"]').find("tile"),u=$(t).find('layer[name="Impassable"]').find("tile"),a=$(t).find('layer[name="Zones"]');a.length>0&&(a=a.find("tile"));for(var f=0;f<this._yLimit;f++){var l=[];for(var c=0;c<this._xLimit;c++){var h=f*this._xLimit+c,p=!0;s!=null&&(p=p&&parseInt(s.eq(h).attr("gid"))==0),p=p&&parseInt(u.eq(h).attr("gid"))==0;var d=0;a.length>0&&(d=parseInt(a.eq(h).attr("gid")),d>0&&(d-=288));var v=new i(this,c,f,p,d);l.push(v)}this._mapSquares.push(l)}},getXLimit:function(){return this._xLimit},getYLimit:function(){return this._yLimit},getTileset:function(){return this._tileset},isOverWorld:function(){return this._overworld},pointInBounds:function(e,t){return e<0||e>=this._xLimit?!1:t<0||t>=this._yLimit?!1:!0},isPassable:function(e,t){return this._mapSquares[t][e].passable()},isOccupied:function(e,t){var n=!1;for(var r=0;r<this._spriteList.length;++r){var i=this._spriteList[r];i.isAt(e,t)&&(n=!0)}return n},getSquareAt:function(e,t){return this.pointInBounds(e,t)?this._mapSquares[t][e]:null},addSprite:function(e){return this._spriteList.push(e),this._spriteList.length-1},removeSprite:function(e){var t;for(var n=0;n<this._spriteList.length;++n)this._spriteList[n]==e&&(t=n);this._spriteList.splice(t,1)},hasSprite:function(e){for(var t=0;t<this._spriteList.length;++t)if(this._spriteList[t]==e)return!0;return!1},getSpriteAt:function(e,t){for(var n=0;n<this._spriteList.length;++n){var r=this._spriteList[n];if(r.isAt(e,t))return r}return null},onEnter:function(){},onExit:function(){},drawSprites:function(){for(var e=0;e<this._spriteList.length;++e){var t=this._spriteList[e];t.plot(),t instanceof p&&t.doesWalk()&&t.startWalking()}},clearSprites:function(){for(var e=0;e<this._spriteList.length;++e){var t=this._spriteList[e];t.clear(),t instanceof p&&t.doesWalk()&&t.stopWalking()}},doAction:function(){var e=on.getFacingCoords(),t=e[0],n=e[1],r=this.getSpriteAt(t,n);r!=null&&r.action()},redraw:function(e,t,n,r){var i=this._xLimit,s=this._tileset,o=n>0?-1:0,u=r>0?-1:0,a=n<0?Ft+1:Ft,f=r<0?It+1:It;$(this._mapXml).find("map layer").each(function(){var l=$(this).attr("visible");if(l!="0"){var c=$(this).find("tile");for(var h=u;h<f;++h)for(var p=o;p<a;++p){var d=(h+t)*i+p+e,v=c.eq(d).attr("gid");v>0&&s.drawClip(v,p,h,n,r)}}})},animate:function(e,t,n,r){un.startAnimating(),un.startScrolling();var i=n-e,s=r-t,o=(s!=0?jt:Bt)/$t,u=this;u.animateSub(e,t,0,0,i,s,o)},animateSub:function(e,t,n,r,i,s,o){this._animation.update();if(o>0){for(var u=0;u<this._spriteList.length;++u){var a=this._spriteList[u];a instanceof p&&(a.isWalking()||a.wasWalking())?(a.clear(n+i*Bt+a._lastOffsetX,r+s*jt+a._lastOffsetY),a._wasWalking=!1):a.clear(n+i*Bt,r+s*jt)}n-=i*$t,r-=s*$t;for(var u=0;u<this._spriteList.length;++u){var a=this._spriteList[u];a instanceof p&&a.isWalking()?(a.plot(0,0,n+i*Bt+a._destOffsetX,r+s*jt+a._destOffsetY),a._wasWalking=!0):a.plot(0,0,n+i*Bt,r+s*jt)}this._lastOffsetX=n+i*Bt,this._lastOffsetY=r+s*jt}this.redraw(e,t,n,r);if(o>0){var f=this;window.setTimeout(function(){f.animateSub(e,t,n,r,i,s,--o)},this._animation.getDelay())}else un.finishAnimating(),un.finishScrolling(),this._lastOffsetX=undefined,this._lastOffsetY=undefined,Pn()}}),o=Class.extend({_init:function(e,t){this._subMapList=[],this._currentSubMap=0,this._scrollX=0,this._scrollY=0;var n=new s(e,t,!0);this._subMapList[0]=n,this._animating=!1,this._scrolling=!1,this._runAfterAnimation=null},getSubMap:function(e){return this._subMapList[e]},getScrollX:function(){return this._scrollX},getScrollY:function(){return this._scrollY},getCurrentSubMapId:function(){return this._currentSubMap},getXLimit:function(){return this._subMapList[this._currentSubMap].getXLimit()},getYLimit:function(){return this._subMapList[this._currentSubMap].getYLimit()},isOverWorld:function(){return this._subMapList[this._currentSubMap].isOverWorld()},pointInBounds:function(e,t){return this._subMapList[this._currentSubMap].pointInBounds(e,t)},isPassable:function(e,t){return this._subMapList[this._currentSubMap].isPassable(e,t)},isOccupied:function(e,t){return this._subMapList[this._currentSubMap].isOccupied(e,t)},getSquareAt:function(e,t){var n=this._subMapList[this._currentSubMap].getSquareAt(e,t);return n},transform:function(e,t){var n=Bt*(e-this._scrollX),r=jt*(t-this._scrollY);return[n,r]},isOnScreen:function(e,t){var n=e-this._scrollX,r=t-this._scrollY;return n>=-1&&n<=Ft&&r>=-1&&r<=It+1},autoScrollToPlayer:function(e,t){var n=!1,r=e-this._scrollX,i=t-this._scrollY,s=0;return r<qt?n=this.scroll(r-qt,0)||n:r>Rt&&(n=this.scroll(r-Rt,0)||n),i<Ut?n=this.scroll(0,i-Ut)||n:i>zt&&(n=this.scroll(0,i-zt)||n),n},scroll:function(e,t){var n=this._scrollX+e,r=this._scrollY+t,i=this.getXLimit(),s=this.getYLimit();n<0&&(n=0),n+Ft>i&&(n=i-Ft),r<0&&(r=0),r+It>s&&(r=s-It);if(n!=this._scrollX||r!=this._scrollY){var o=this._scrollX,u=this._scrollY;return this._scrollX=n,this._scrollY=r,this.animate(o,u,n,r),!0}return!1},redraw:function(){this._subMapList[this._currentSubMap].redraw(this._scrollX,this._scrollY,0,0)},animate:function(e,t,n,r){this._subMapList[this._currentSubMap].animate(e,t,n,r)},addSubMap:function(e,t){this._subMapList[e]=t},goToMap:function(e,t,n,r,i,s,o){e.clear();var u=this._subMapList[this._currentSubMap];u.onExit(),u.clearSprites(),Zt.clearRect(0,0,Yt.width,Yt.height),this._currentSubMap=t,e.enterNewSubMap(t,n,r,o),this.goTo(i,s);var a=this._subMapList[t];a.drawSprites(),a.onEnter(),e.plot()},goTo:function(e,t){this._scrollX=e,this._scrollY=t,this.redraw()},doAction:function(){this._subMapList[this._currentSubMap].doAction()},drawSprites:function(){this._subMapList[this._currentSubMap].drawSprites()},clearSprites:function(){this._subMapList[this._currentSubMap].clearSprites()},isAnimating:function(){return this._animating},startAnimating:function(){this._animating=!0},finishAnimating:function(){this._animating=!1,this._runAfterAnimation&&(this._runAfterAnimation(),this._runAfterAnimation=null)},isScrolling:function(){return this._scrolling},startScrolling:function(){this._scrolling=!0},finishScrolling:function(){this._scrolling=!1},runAfterAnimation:function(e){this._runAfterAnimation||(this._runAfterAnimation=e)},createSaveData:function(){return{scrollX:this._scrollX,scrollY:this._scrollY}},loadSaveData:function(e){this._scrollX=e.scrollX,this._scrollY=e.scrollY}}),u=Class.extend({_init:function(e,t,n,r,i,s,o,u){this._x=e,this._y=t,this._width=n,this._height=r,this._subMap=s,this._img=Bn.images[i].img,this._sx=o!=undefined?o:0,this._sy=u!=undefined?u:0},getX:function(){return this._x},getY:function(){return this._y},getSubMap:function(){return this._subMap},isAt:function(e,t){return this._x==e&&this._y==t},plot:function(e,t,n,r){if(un.getCurrentSubMapId()!=this._subMap)return;if(!un.isOnScreen(this._x,this._y))return;var i=this._width,s=this._height,o=this._width,u=this._height,a=un.getSubMap(this._subMap);a.isOverWorld()&&(o=Math.ceil(Bt*jt/Xt),u=jt);var f=un.transform(this._x,this._y),l=f[0],c=f[1];l+=Math.floor((Bt-o)/2),c+=jt-u;var h=this._sx;e!=undefined&&(h+=e);var p=this._sy;t!=undefined&&(p+=t),n!=undefined&&(l+=n),r!=undefined&&(c+=r),Zt.drawImage(this._img,h,p,i,s,l,c,o,u);if(!a.isOverWorld())if(this==on){var d=a.getSpriteAt(this._x,this._y+1);d!=null&&(un.isScrolling()?a._lastOffsetX!=undefined&&d.plot(0,0,a._lastOffsetX,a._lastOffsetY):d.plot());var d=a.getSpriteAt(this._prevX,this._prevY+1);d!=null&&(un.isScrolling()?a._lastOffsetX!=undefined?d.plot(0,0,a._lastOffsetX,a._lastOffsetY):d.plot(0,0,(this._x-this._prevX)*Bt,(this._y-this._prevY)*jt):d.plot())}else on.isAt(this._x,this._y+1)&&on.plot()},clear:function(e,t){if(un.getCurrentSubMapId()!=this._subMap)return;if(!un.isOnScreen(this._x,this._y))return;var n=un.transform(this._x,this._y),r=n[0],i=n[1],s=this._width,o=this._height,u=un.getSubMap(this._subMap);u.isOverWorld()&&(s=Math.ceil(Bt*jt/Xt),o=jt),r+=Math.floor((Bt-s)/2),i+=jt-o,e!=undefined&&(r+=e),t!=undefined&&(i+=t),Zt.clearRect(r,i,s,o);if(!u.isOverWorld())if(this==on){var a=u.getSpriteAt(this._x,this._y-1);a!=null&&(un.isScrolling()?u._lastOffsetX!=undefined&&a.plot(0,0,u._lastOffsetX,u._lastOffsetY):a.plot());var a=u.getSpriteAt(this._prevX,this._prevY-1);a!=null&&(un.isScrolling()?u._lastOffsetX!=undefined&&a.plot(0,0,u._lastOffsetX,u._lastOffsetY):a.plot());var f=u.getSpriteAt(this._prevX,this._prevY+1);f!=null&&(un.isScrolling()?u._lastOffsetX!=undefined&&f.plot(0,0,u._lastOffsetX,u._lastOffsetY):f.plot())}else un.isScrolling()||(on.isAt(this._x,this._y-1)&&on.plot(),on.isAt(this._x,this._y+1)&&on.plot())},action:function(){}}),a=u.extend({_init:function(e,t,n,r,i){this._super(e,t,Bt,jt,n,r),this._flagName=i,this._open=!1;var s=this;sn.addLoadFunction(function(){sn.isFlagSet(s._flagName)?s._open=!0:s._open=!1})},isOpen:function(){return this._open},open:function(){this.clear(),this._open=!0,sn.setFlag(this._flagName),this.plot()},plot:function(e,t,n,r){var i=0;this._open&&(i=Bt),this._super(i,0,n,r)},onOpenFindGold:function(e){this.isOpen()||(this.open(),on.earnGold(e),fn.displayText("You found "+e+" gold."))},onOpenFindItem:function(e,t,n){this.isOpen()||(this.open(),on.addToInventory(t,n),fn.displayText(e))},onOpenLearnSpell:function(e){if(!this.isOpen()){this.open(),on.learnSpell(e);var t="You found a spell book.\n",n=Fr.spells[e].name;t+="You learned "+n+".",fn.displayText(t)}}}),f=0,l=1,c=2,h=3,p=u.extend({_init:function(e,t,n,r,i,s){this._super(e,t,Wt,Xt,n,r),this._dir=i,this._walks=s?!0:!1,this._walking=!1,this._wasWalking=!1,this._entered=!1},getDir:function(){return this._dir},doesWalk:function(){return this._walks},isWalking:function(){return this._walking},wasWalking:function(){return this._wasWalking},getFacingCoords:function(){var e=this._x,t=this._y;switch(this._dir){case f:t--;break;case c:t++;break;case h:e--;break;case l:e++}return[e,t]},facePlayer:function(){switch(on.getDir()){case f:this._dir=c;break;case c:this._dir=f;break;case h:this._dir=l;break;case l:this._dir=h}this.clear(),this.plot()},plot:function(e,t,n,r){if(this._walking&&n===undefined&&r===undefined)return;var i=Xt*this._dir,s=Wt;e!=undefined&&(s+=e),this._super(s,i,n,r)},move:function(e,t,n){this._dir=n;var r=this._x+e,i=this._y+t;if(!un.pointInBounds(r,i)||!un.isPassable(r,i)||un.isOccupied(r,i)||on.isAt(r,i))return un.isAnimating()||(this.clear(),this.plot()),!1;this.clear(),this._prevX=this._x,this._prevY=this._y,this._x+=e,this._y+=t;if(this==on){var s=un.autoScrollToPlayer(this._x,this._y);s?this.scrollAnimation():this.walkAnimation(e,t),this._entered=!1;var o=this;un.runAfterAnimation(function(){o._entered||o.getSquareUnderfoot().onEnter(),o._entered=!0})}else this._walks&&this.walkAnimation(e,t);return!0},enterNewSubMap:function(e,t,n,r){this._x=t,this._y=n,this._dir=r,this._subMap=e},getSquareUnderfoot:function(){return un.getSquareAt(this._x,this._y)},startWalking:function(){this.walk()},stopWalking:function(){window.clearTimeout(this._walkTimeout)},walk:function(){var e,t,n=Math.floor(Math.random()*4);switch(n){case f:e=0,t=-1;break;case c:e=0,t=1;break;case h:e=-1,t=0;break;case l:e=1,t=0}this.move(e,t,n);var r=this;this._walkTimeout=window.setTimeout(function(){r.walk()},1e3)},scrollAnimation:function(){un.isScrolling()&&this.scrollAnimationSub(0)},scrollAnimationSub:function(e){if(un.isScrolling()&&!hn){this.clear();var t=0;if(e==2||e==3)t=-Wt;else if(e==6||e==7)t=Wt;this.plot(t);var n=this;window.setTimeout(function(){n.scrollAnimationSub((e+1)%8)},1e3/Vt)}else hn||(this.clear(),this.plot())},walkAnimation:function(e,t){if(this==on&&un.isAnimating()){var n=this;un.runAfterAnimation(function(){n.walkAnimation(e,t)})}else if(!hn){this==on&&un.startAnimating(),this._lastOffsetX=0,this._lastOffsetY=0,this._walking=!0;var r=(t!=0?jt:Bt)/$t,i=-e*Bt,s=-t*jt;this._destOffsetX=i,this._destOffsetY=s,this.walkAnimationSub(0,e,t,i,s,r)}},walkAnimationSub:function(e,t,n,r,i,s){if(s>1&&!hn){this.clear(r,i);var o=0;if(e==2||e==3)o=-Wt;else if(e==6||e==7)o=Wt;this._lastOffsetX=r,this._lastOffsetY=i,r+=t*$t,i+=n*$t,this._destOffsetX=r,this._destOffsetY=i,(this==on||!un.isScrolling())&&this.plot(o,0,r,i);var u=this;window.setTimeout(function(){u.walkAnimationSub((e+1)%8,t,n,r,i,--s)},1e3/Vt)}else this._walking=!1,!hn&&(this==on||!un.isScrolling())&&(this.clear(r,i),this.plot()),this==on&&un.finishAnimating(),hn||Pn()}}),d=p.extend({_init:function(e,t,n,r,i,s){this._super(e,t,n,r,i),this._player=qr.players[s],this.reset()},reset:function(){this._name=this._player.name,this._exp=this._player.exp,this._gold=this._player.gold,this._level=this._player.level,this._maxHP=this._player.maxHP,this._maxMP=this._player.maxMP,this._hp=this._player.maxHP,this._mp=this._player.maxMP,this._attack=this._player.attack,this._defense=this._player.defense,this._levels=this._player.levels,this._weapon=this._player.weapon,this._armor=this._player.armor,this._helmet=this._player.helmet,this._shield=this._player.shield,this._inventory=this._player.inventory,this._spells=this._player.spells},getName:function(){return this._name},getExp:function(){return this._exp},getNextExp:function(){return this._levels[this._level]},getGold:function(){return this._gold},getMaxHP:function(){return this._maxHP},getMaxMP:function(){return this._maxMP},getHP:function(){return this._hp},getMP:function(){return this._mp},getAttack:function(){return this._attack+Mr.items[this._weapon].attack},getDefense:function(){return this._defense+Mr.items[this._armor].defense+Mr.items[this._helmet].defense+Mr.items[this._shield].defense},getLevel:function(){return this._level},getWeapon:function(){return this._weapon},getArmor:function(){return this._armor},getHelmet:function(){return this._helmet},getShield:function(){return this._shield},isDead:function(){return this._hp<=0},damage:function(e){this._hp-=e},heal:function(e){this._hp+=e,this._hp>this._maxHP&&(this._hp=this._maxHP)},useMP:function(e){this._mp-=e},gainMP:function(e){this._mp+=e,this._mp>this._maxMP&&(this._mp=this._maxMP)},restore:function(){this._hp=this._maxHP,this._mp=this._maxMP},earnExp:function(e){return this._exp+=e,this._level<this._player.max_levels&&this._exp>=this.getNextExp()?(this._level++,this._attack+=this._player.attack_increase,this._defense+=this._player.defense_increase,this._maxHP+=this._player.maxHP_increase,this._maxMP+=this._player.maxMP_increase,!0):!1},earnGold:function(e){this._gold+=e},spendGold:function(e){this._gold-=e},equipWeapon:function(e){this._weapon=e},equipArmor:function(e){this._armor=e},equipHelmet:function(e){this._helmet=e},equipShield:function(e){this._shield=e},addToInventory:function(e,t){t==undefined&&(t=1),this._inventory[e]?this._inventory[e]+=t:this._inventory[e]=t},numInInventory:function(e){return parseInt(this._inventory[e])},removeFromInventory:function(e,t){t==undefined&&(t=1),this._inventory[e]-=t},forEachItemInInventory:function(e){for(var t in this._inventory)e(t,this._inventory[t])},learnSpell:function(e){this._spells.push(e)},forEachSpell:function(e){for(var t in this._spells)e(t)},createSaveData:function(){return{exp:this._exp,gold:this._gold,level:this._level,maxHP:this._maxHP,maxMP:this._maxMP,hp:this._hp,mp:this._mp,attack:this._attack,defense:this._defense,weapon:this._weapon,armor:this._armor,helmet:this._helmet,shield:this._shield,inventory:this._inventory,spells:this._spells,x:this._x,y:this._y,subMap:this._subMap,dir:this._dir}},loadSaveData:function(e){this._exp=e.exp,this._gold=e.gold,this._level=e.level,this._maxHP=e.maxHP,this._maxMP=e.maxMP,this._hp=e.hp,this._mp=e.mp,this._attack=e.attack,this._defense=e.defense,this._weapon=e.weapon,this._armor=e.armor,this._helmet=e.helmet,this._shield=e.shield,this._inventory=e.inventory,this._spells=e.spells,this._x=e.x,this._y=e.y,this._subMap=e.subMap,this._dir=e.dir}}),v=Class.extend({_init:function(e){this._monster=e,this._maxHP=e.hp,this._hp=e.hp,this._loc=0},getHP:function(){return this._hp},damage:function(e){this._hp-=e},heal:function(e){this._hp+=e,this._hp>this._maxHP&&(this._hp=this._maxHP)},isDead:function(){return this._hp<=0},getLoc:function(){return this._loc},setLoc:function(e){this._loc=e},getName:function(){return this._monster.name},getAttack:function(){return this._monster.attack},getDefense:function(){return this._monster.defense},getExp:function(){return this._monster.exp},getGold:function(){return this._monster.gold},getImageRef:function(){return this._monster.imgRef},getLeft:function(){return this._monster.left},getTop:function(){return this._monster.top},getWidth:function(){return this._monster.width},getHeight:function(){return this._monster.height},hasSpecialAttack:function(){return!!this._monster.special},useSpecialAttack:function(){this._monster.special(this)}}),m=Class.extend({_init:function(e,t,n){this._width=e,this._height=t,this._url=Bn.images[n].url,this._img=Bn.images[n].img},drawClip:function(e,t,n,r,i){var e=parseInt(e);e--;var s=Bt,o=jt,u=this._width/s,a=e%u*s,f=Math.floor(e/u)*o,l=t*s+r,c=n*o+i;Gt.drawImage(this._img,a,f,s,o,l,c,s,o)}}),g=Class.extend({_init:function(){this._textDisplayed=!1,this._callback=null},setCallback:function(e){this._callback=e},textDisplayed:function(){return this._textDisplayed},displayText:function(e){rn.fillStyle="rgba(0, 0, 100, 0.75)",rn.fillRect(0,236,nn.width,100),rn.fillStyle="white",rn.font="bold 16px monospace",rn.textBaseline="top";var t=e.split("\n"),n=0;do rn.fillText(t[n],10,246+22*n);while(t.length>++n);this._textDisplayed=!0},clearText:function(){rn.clearRect(0,236,nn.width,100),this._textDisplayed=!1,this._callback&&(this._callback(),this._callback=null)}}),y=Class.extend({_init:function(e){this._type=e.type,this._displayed=!1,this._num=e.numberSelections,this._drawBox=e.drawBox,this._left=e.left,this._top=e.top,this._width=e.width,this._height=e.height,this._radius=e.radius,this._thickness=e.thickness,this._textLeft=e.textLeft,this._heights=e.heights,this._texts=e.texts,this._font=e.font,this._canESC=!0,this._beforeCallback=e.beforeCallback?e.beforeCallback:function(){},this._afterCallback=e.afterCallback?e.afterCallback:function(){},this._beforeClear=e.beforeClear?e.beforeClear:function(){},this._afterClear=e.afterClear?e.afterClear:function(){}},display:function(){this._drawBox&&wn(tn,this._left,this._top,this._width,this._height,this._radius,this._thickness),rn.font=this._font,rn.textBaseline="top",this.drawText(),this._num>0&&this.drawPointer(),this._displayed=!0},isDisplayed:function(){return this._displayed},clear:function(){this._drawBox&&tn.clearRect(this._left,this._top,this._width,this._height),rn.clearRect(this._left,this._top,this._width,this._height),this._displayed=!1},getType:function(){return this._type},drawPointer:function(){},clearPointer:function(){},drawText:function(){for(var e=0;e<this._num;++e)rn.fillText(this._texts[e],this._textLeft,this._heights[e])},handleKey:function(e){},handleEnter:function(){this._beforeCallback(),this.handleESC(),this._afterCallback()},handleESC:function(){this._displayed&&this._canESC&&(this._beforeClear(),this.clear(),this._afterClear())}}),b=y.extend({_init:function(e){this._super(e),this._current=0,this._pointer=!1,this._pointerLeft=e.pointerLeft,this._flags=e.flags,this._callbacks=e.callbacks,this._canESC=e.canESC,this._onFlag=e.onFlag?e.onFlag:function(){}},drawPointer:function(){var e=this._heights[this._current%this._num],t=Bn.images.pointer.img;rn.drawImage(t,this._pointerLeft,e+2),this._pointer=!0},clearPointer:function(){var e=this._heights[this._current%this._num];rn.clearRect(this._pointerLeft,e+2,16,11),this._pointer=!1},drawText:function(){for(var e=0;e<this._num;++e)rn.fillStyle=this._flags?this._flags[e]?"gray":"white":"white",rn.fillText(this._texts[e],this._textLeft,this._heights[e])},handleKey:function(e){if(this._displayed){this.clearPointer();switch(e){case Sn:case Nn:this._current++,this._current%=this._num;break;case xn:case Tn:this._current--,this._current<0&&(this._current+=this._num)}this.drawPointer()}},handleEnter:function(){this._displayed&&(this._flags&&this._flags[this._current]?this._onFlag():this._num>0?(this._beforeCallback(),this._callbacks[this._current](),this._afterCallback()):this.handleESC())},createCallbacks:function(e){var t=[],n=this;for(var r=0;r<e;++r)t[r]=function(e){return function(){n.callback(e)}}(r);return t}}),w=b.extend({_init:function(e){this._super(e),this._lineTop=e.lineTop,this._textLefts=e.textLefts,this._pointerLefts=e.pointerLefts},drawPointer:function(){var e=this._pointerLefts[this._current%this._num],t=Bn.images.pointer.img;rn.drawImage(t,e,this._lineTop+2),this._pointer=!0},clearPointer:function(){var e=this._pointerLefts[this._current%this._num];rn.clearRect(e,this._lineTop+2,16,11),this._pointer=!1},drawText:function(){for(var e=0;e<this._num;++e)rn.fillStyle=this._flags?this._flags[e]?"gray":"white":"white",rn.fillText(this._texts[e],this._textLefts[e],this._lineTop)}}),E=b.extend({_init:function(e){this._mainMenu=e,this._items=[];var t=this._getItems(),n=this._getTexts(),r=this._getFlags(),i=this.createCallbacks(t),s=this;this._super({type:q,numberSelections:t,drawBox:!0,left:150,top:0,width:250,height:200,radius:25,thickness:4,pointerLeft:170,textLeft:186,heights:[20,48,76,104,132,160],texts:n,flags:r,font:"bold 20px monospace",callbacks:i,canESC:!0,afterCallback:function(){s._mainMenu.setCurrentMenu(s._mainMenu)},afterClear:function(){s._mainMenu.returnTo()}})},_getItems:function(){var e=0,t=this;return on.forEachItemInInventory(function(n,r){if(r>0){var i={};i.name=Mr.items[n].name,i.type=Mr.items[n].type,i.amt=r,i.id=n,i.canUse=i.type==Yn,t._items.push(i),e++}}),e},_getTexts:function(){var e=[];for(var t=0;t<this._items.length;++t){var n=this._items[t],r=n.amt<10?" "+n.amt:n.amt;e[t]=n.name+":"+r}return e},_getFlags:function(){return _.map(this._items,function(e,t){return!e.canUse})},callback:function(e){var t=this._items[e];this.clear(),this._mainMenu.clear();var n=Mr.items[t.id];n.use(on),on.removeFromInventory(t.id)}}),S=b.extend({_init:function(e){this._mainMenu=e,this._spells=[];var t=this._getSpells(),n=this._getTexts(),r=this._getFlags(),i=this.createCallbacks(t),s=this;this._super({type:R,numberSelections:t,drawBox:!0,left:150,top:0,width:250,height:200,radius:25,thickness:4,pointerLeft:170,textLeft:186,heights:[20,48,76,104,132,160],texts:n,flags:r,font:"bold 20px monospace",callbacks:i,canESC:!0,afterCallback:function(){s._mainMenu.setCurrentMenu(s._mainMenu)},afterClear:function(){s._mainMenu.returnTo()}})},_getSpells:function(){var e=0,t=this;return on.forEachSpell(function(n){var r={};r.name=Fr.spells[n].name,r.type=Fr.spells[n].type,r.id=n,r.canUse=r.type==Pr,t._spells.push(r),e++}),e},_getTexts:function(){var e=[];for(var t=0;t<this._spells.length;++t){var n=this._spells[t];e[t]=n.name}return e},_getFlags:function(){return _.map(this._spells,function(e,t){return!e.canUse})},callback:function(e){var t=this._spells[e];this.clear(),this._mainMenu.clear();var n=Fr.spells[t.id];on.getMP()>=n.mpCost?(n.use(on),on.useMP(parseInt(n.mpCost))):fn.displayText("You do not have enough mp to use "+t.name+".")}}),x=4,T=0,N=1,C=2,k=3,L=b.extend({_init:function(e){this._mainMenu=e;var t=this.createCallbacks(x),n=this;this._super({type:U,numberSelections:x,drawBox:!0,left:150,top:0,width:250,height:200,radius:25,thickness:4,pointerLeft:170,textLeft:195,heights:[20,60,100,140],font:"bold 16px monospace",callbacks:t,canESC:!0,afterClear:function(){n._mainMenu.returnTo()}})},drawText:function(){rn.fillText("Weapon:",this._textLeft,this._heights[0]),rn.fillText(Mr.items[on.getWeapon()].name,210,40),rn.fillText("Armor:",this._textLeft,this._heights[1]),rn.fillText(Mr.items[on.getArmor()].name,210,80),rn.fillText("Helmet:",this._textLeft,this._heights[2]),rn.fillText(Mr.items[on.getHelmet()].name,210,120),rn.fillText("Shield:",this._textLeft,this._heights[3]),rn.fillText(Mr.items[on.getShield()].name,210,160)},callback:function(e){var t=new A(this._mainMenu,this,e);t.display(),this._mainMenu.setCurrentMenu(t)},returnTo:function(){this.clear(),this.display(),this._mainMenu.setCurrentMenu(this)}}),A=b.extend({_init:function(e,t,n){this._mainMenu=e,this._equipType=n,this._parent=t;var r=this._getItems(),i=this._getTexts(),s=this.createCallbacks(r),o=this;this._super({type:J,numberSelections:r,drawBox:!0,left:150,top:200,width:250,height:150,radius:25,thickness:4,pointerLeft:170,textLeft:195,heights:[220,240,260,280,300],texts:i,font:"bold 16px monospace",callbacks:s,canESC:!0,afterCallback:function(){},afterClear:function(){o._parent.returnTo()}})},_getEquivType:function(e){switch(e){case T:return er;case N:return tr;case C:return nr;case k:return rr}},_getItems:function(){var e=this._getEquivType(this._equipType);this._items=[];var t=0,n=this;return on.forEachItemInInventory(function(r,i){if(i>0){var s=Mr.items[r].type;if(s==e){var o={};o.name=Mr.items[r].name,o.type=s,o.amt=i,o.id=r,n._items.push(o),t++}}}),t},_getTexts:function(){var e=[];for(var t=0;t<this._items.length;++t){var n=this._items[t];e[t]=n.name}return e},callback:function(e){this.changeEquip(e),this.clear(),this._parent.returnTo()},changeEquip:function(e){var t,n=this
._items[e].id;switch(this._equipType){case T:t=on.getWeapon(),on.equipWeapon(n);break;case N:t=on.getArmor(),on.equipArmor(n);break;case C:t=on.getHelmet(),on.equipHelmet(n);break;case k:t=on.getShield(),on.equipShield(n)}on.removeFromInventory(n),on.addToInventory(t)}}),O=4,M=b.extend({_init:function(e){this._mainMenu=e;var t=this.createCallbacks(O),n=this;this._super({numberSelections:O,drawBox:!0,left:150,top:0,width:250,height:200,radius:25,thickness:4,pointerLeft:170,textLeft:195,heights:[20,60,100,140],font:"bold 16px monospace",callbacks:t,canESC:!0,afterCallback:function(){n._mainMenu.setCurrentMenu(n._mainMenu)},afterClear:function(){n._mainMenu.returnTo()}})}}),D=M.extend({_init:function(e){this._super(e),this._type=W},drawText:function(){for(var e=1;e<=O;++e)rn.font="bold 16px monospace",rn.fillText("Save Slot "+e+":",this._textLeft,this._heights[e-1]),sn.hasSaveInfo(e)?(rn.font="bold 14px monospace",rn.fillText(sn.getSaveInfo(e),this._textLeft+15,this._heights[e-1]+20)):(rn.font="italic 14px serif",rn.fillText("Empty",this._textLeft+15,this._heights[e-1]+20))},callback:function(e){this.clear(),this._mainMenu.clear();var t=e+1;sn.save(t),fn.displayText("Game saved to slot "+t+".")}}),P=M.extend({_init:function(e){this._super(e),this._type=X;var t=this;this._afterCallback=function(){an?(an=!1,ln.setCurrentMenu(ln)):ln.setCurrentMenu(e)}},drawText:function(){for(var e=1;e<=O;++e)sn.hasSaveInfo(e)?(rn.font="bold 16px monospace",rn.fillStyle="white",rn.fillText("Save Slot "+e+":",195,40*e-20),rn.font="bold 14px monospace",rn.fillText(sn.getSaveInfo(e),210,40*e)):(rn.font="bold 16px monospace",rn.fillStyle="gray",rn.fillText("Save Slot "+e+":",195,40*e-20),rn.font="italic 14px serif",rn.fillText("Empty",210,40*e))},callback:function(e){this.clear(),this._mainMenu.clear(),this.loadGame(e+1)},loadGame:function(e){try{sn.load(e),Zt.clearRect(0,0,Yt.width,Yt.height),un.goToMap(on,on.getSubMap(),on.getX(),on.getY(),un.getScrollX(),un.getScrollY(),on.getDir())}catch(t){if(t instanceof _t)fn.displayText("There is no saved game in slot"+e+".");else{if(!(t instanceof Dt))throw t;fn.displayText("The game saved is from an old,\nincompatible version.")}}}}),H=2,B=0,j=1,F=b.extend({_init:function(e){var t=this;this._mainMenu=e,this._super({type:K,numberSelections:H,drawBox:!0,left:0,top:0,width:175,height:90,radius:25,thickness:4,pointerLeft:24,textLeft:44,heights:[20,48],texts:["New Game","Load Game"],font:"bold 20px monospace",callbacks:[function(){t._mainMenu.onNewGame()},function(){t.displayLoadMenu()}],canESC:!0,afterClear:function(){ln.clearTitleScreenMenu()}}),this._currentMenu=this},display:function(){this._mainMenu.setDisplayed(!0),this._super()},clear:function(){this._mainMenu.setDisplayed(!1),this._super()},displayLoadMenu:function(){var e=new P(this);e.display(),this._currentMenu=e},handleKey:function(e){this._currentMenu==this?this._super(e):this._currentMenu.handleKey(e)},handleEnter:function(){this._currentMenu==this?this._super():this._currentMenu.handleEnter()},handleESC:function(){this._currentMenu==this?this._super():this._currentMenu.handleESC()},getCurrentMenu:function(){return this._mainMenu.getCurrentMenu()},setCurrentMenu:function(e){this._mainMenu.setCurrentMenu(e)},returnTo:function(){this._mainMenu.setCurrentMenu(this),this._currentMenu=this,this.display(),this.drawPointer()},setDisplayed:function(e){this._displayed=e}}),I=0,q=1,R=2,U=3,z=4,W=5,X=6,V=7,J=8,K=9,Q=0,G=1,Y=2,Z=3,et=4,tt=5,nt=6,rt=b.extend({_init:function(){var e=this;this._super({type:I,numberSelections:nt,drawBox:!0,left:0,top:0,width:150,height:200,radius:25,thickness:4,pointerLeft:24,textLeft:42,heights:[20,48,76,104,132,160],texts:["Item","Spell","Equip","Status","Save","Load"],font:"bold 20px monospace",callbacks:[function(){e.displayItemMenu()},function(){e.displaySpellMenu()},function(){e.displayEquipMenu()},function(){e.displayStatusMenu()},function(){e.displaySaveMenu()},function(){e.displayLoadMenu()}],canESC:!0}),this._onNewGame=null,an?this._currentMenu=new F(this):this._currentMenu=this},getCurrentMenu:function(){return this._currentMenu},setCurrentMenu:function(e){this._currentMenu=e},returnTo:function(){this._currentMenu=this,this.clear(),this.display(),this.drawPointer()},setOnNewGame:function(e){this._onNewGame=e},onNewGame:function(){this._currentMenu.clear(),this._onNewGame(),an=!1,this.setCurrentMenu(this)},setDisplayed:function(e){this._displayed=e},displayTitleScreenMenu:function(){var e=new F(this);e.display(),this._currentMenu=e,this._displayed=!0},clearTitleScreenMenu:function(){this._displayed=!1},displayNotImplementedMenu:function(){var e=new it(this);e.display(),this._currentMenu=e},displayItemMenu:function(){var e=new E(this);e.display(),this._currentMenu=e},displaySpellMenu:function(){var e=new S(this);e.display(),this._currentMenu=e},displayEquipMenu:function(){var e=new L(this);e.display(),this._currentMenu=e},displayStatusMenu:function(){var e=new st(this);e.display(),this._currentMenu=e},displaySaveMenu:function(){var e=new D(this);e.display(),this._currentMenu=e},displayLoadMenu:function(){var e=new P(this);e.display(),this._currentMenu=e},handleKey:function(e){this._currentMenu==this?this._super(e):this._currentMenu.handleKey(e)},handleEnter:function(){this._currentMenu==this?this._super():this._currentMenu.handleEnter()},handleESC:function(){this._currentMenu==this?this._super():this._currentMenu.handleESC()}}),it=y.extend({_init:function(e){this._mainMenu=e;var t=this;this._super({type:V,numberSelections:0,drawBox:!0,left:150,top:0,width:250,height:200,radius:25,thickness:4,textLeft:170,heights:[],texts:[],font:"bold 20px monospace",afterClear:function(){t._mainMenu.returnTo()}})}}),st=y.extend({_init:function(e){this._mainMenu=e;var t=this._getTexts(),n=this;this._super({type:z,numberSelections:7,drawBox:!0,left:150,top:0,width:250,height:200,radius:25,thickness:4,textLeft:180,heights:[18,36,54,72,90,108,126],texts:t,font:"bold 14px monospace",afterCallback:function(){n._mainMenu.setCurrentMenu(n._mainMenu)},afterClear:function(){n._mainMenu.returnTo()}})},_getTexts:function(){var e=[];return e[0]="HP:      "+on.getHP()+"/"+on.getMaxHP(),e[1]="MP:      "+on.getMP()+"/"+on.getMaxMP(),e[2]="Attack:  "+on.getAttack(),e[3]="Defense: "+on.getDefense(),e[4]="Level:   "+on.getLevel(),e[5]="Exp:     "+on.getExp()+"/"+on.getNextExp(),e[6]="Gold:    "+on.getGold(),e}}),ot=b.extend({_init:function(e,t,n){var r=this;this._parent=e,this._shop=t,this._itemList=n,this._items=[];var i=this._getItems(),s=this._getTexts(),o=this.createCallbacks(i);this._super({type:ft,numberSelections:i,drawBox:!0,left:100,top:0,width:300,height:250,radius:40,thickness:5,pointerLeft:124,textLeft:144,heights:[35,55,75,95,115,135,155,175,195,215],texts:s,font:"bold 16px monospace",callbacks:o,canESC:!0,afterClear:function(){r._parent.returnTo()}})},_getItems:function(){var e=0,t=this;for(var n=0;n<this._itemList.length;++n){var r=this._itemList[n],i={};i.name=Mr.items[r].name,i.type=Mr.items[r].type,i.cost=Mr.items[r].cost,i.id=r,t._items.push(i),e++}return e},_getTexts:function(){var e=[];for(var t=0;t<this._items.length;++t){var n=this._items[t],r=n.name;while(r.length<16)r+=" ";var i=n.cost+"";while(i.length<5)i=" "+i;e[t]=r+i}return e},callback:function(e){this._shop.handlePurchase(this._items[e])}}),ut=b.extend({_init:function(e,t){var n=this;this._parent=e,this._shop=t,this._items=[];var r=this._getItems(),i=this._getTexts(),s=this.createCallbacks(r);this._super({type:lt,numberSelections:r,drawBox:!0,left:100,top:0,width:300,height:250,radius:40,thickness:5,pointerLeft:124,textLeft:144,heights:[35,55,75,95,115,135,155,175,195,215],texts:i,font:"bold 14px monospace",callbacks:s,canESC:!0,afterClear:function(){n._parent.returnTo()}})},_getItems:function(){var e=0,t=this;return on.forEachItemInInventory(function(n,r){if(r>0){var i={};i.id=n,i.name=Mr.items[n].name,i.amt=r,i.cost=Mr.items[n].cost,i.sellPrice=Math.floor(i.cost*Gn),t._items.push(i),e++}}),e},_getTexts:function(){var e=[];for(var t=0;t<this._items.length;++t){var n=this._items[t],r=n.amt,i=r>=10?r:" "+r,s=n.sellPrice.toString();while(s.length<5)s=" "+s;var o=n.name;while(o.length<15)o+=" ";e[t]=o+" "+i+" "+s+"G"}return e},callback:function(e){this._shop.handleSale(this._items[e]),this._shop.isQuantityDialogDisplayed()||this._parent.setCurrentMenu(this._parent)}}),at=0,ft=1,lt=2,ct=3,ht=0,pt=1,dt=2,vt=b.extend({_init:function(e){this._shop=e;var t=this;this._super({type:at,numberSelections:ct,drawBox:!0,left:0,top:0,width:100,height:100,radius:15,thickness:3,pointerLeft:13,textLeft:32,heights:[12,40,68],texts:["Buy","Sell","Exit"],font:"bold 20px monospace",callbacks:[function(){t.displayBuyMenu()},function(){t.displaySellMenu()},function(){t.handleESC()}],afterClear:function(){t.afterClear()},canESC:!0}),this._currentMenu=this},getShop:function(){return this._shop},returnTo:function(){this._currentMenu=this,this.clear(),this.display(),this.drawPointer()},afterClear:function(){fn.displayText("Thank you for your business.\nPlease come again.")},display:function(){this._super(),this.displayGold()},clear:function(){this._super(),this.clearGold()},displayGold:function(){wn(tn,0,120,100,40,10,2),rn.font="bold 20px monospace",rn.fillStyle="white",rn.textBaseline="top",rn.fillText(on.getGold()+"G",16,130)},clearGold:function(){tn.clearRect(0,120,100,50),rn.clearRect(0,120,100,50)},displayBuyMenu:function(){var e=new ot(this,this.getShop(),this.getShop().getItemList());e.display(),this._currentMenu=e},displaySellMenu:function(){var e=new ut(this,this.getShop());e.display(),this._currentMenu=e},getCurrentMenu:function(){return this._currentMenu},setCurrentMenu:function(e){this._currentMenu=e},handleKey:function(e){this._currentMenu==this?this._super(e):this._currentMenu.handleKey(e)},handleEnter:function(){this._currentMenu==this?this._super():this._currentMenu.handleEnter()},handleESC:function(){this._currentMenu==this?this._super():this._currentMenu.handleESC()}}),mt=w.extend({_init:function(e,t,n){this._parent=e,this._battle=t,this._monsterList=n;var r=this.createCallbacks(n.length),i=_.map(n,function(e){return e.getLoc()}),s=this;this._super({type:St,numberSelections:n.length,drawBox:!1,left:i[0]-10,top:3*jt,width:i[n.length-1]+6,height:13,lineTop:3*jt,pointerLefts:_.map(i,function(e){return e-10}),textLefts:i,texts:["","",""],callbacks:r,canESC:!0,afterCallback:function(){s.clear()},afterClear:function(){s._parent.returnTo(!1)}})},drawText:function(){},callback:function(e){this._battle.doActionToMonster(e)},handleKey:function(e){if(this._displayed){this.clearPointer();switch(e){case Sn:case Nn:do this._current++,this._current%=this._num;while(this._monsterList[this._current].isDead());break;case xn:case Tn:do this._current--,this._current<0&&(this._current+=this._num);while(this._monsterList[this._current].isDead())}this.drawPointer()}},selectFirstLiveMonster:function(){for(var e=0;e<this._monsterList.length;++e)if(!this._monsterList[e].isDead()){this._current=e;break}}}),gt=b.extend({_init:function(e,t){this._battle=t,this._parent=e;var n=Qt.width,r=Qt.height;this._items=[];var i=this._getItems(),s=this._getTexts(),o=this._getFlags(),u=this.createCallbacks(i),a=this;this._super({type:wt,numberSelections:i,drawBox:!1,left:133,top:r-150,width:n-133,height:150,radius:15,thickness:3,pointerLeft:154,textLeft:180,heights:[r-132,r-110,r-86,r-62,r-38],texts:s,flags:o,font:"bold 16px sans-serif",callbacks:u,canESC:!0,onFlag:function(){a._battle.setMonsterWillAttack(!1)},afterCallback:function(){a._parent.returnTo(!0)},afterClear:function(){a._parent.returnTo(!0)}})},_getItems:function(){var e=0,t=this;return on.forEachItemInInventory(function(n,r){if(r>0){var i={};i.name=Mr.items[n].name,i.type=Mr.items[n].type,i.amt=r,i.id=n,i.canUse=Mr.items[n].usable,t._items.push(i),e++}}),e},_getTexts:function(){var e=[];for(var t=0;t<this._items.length;++t){var n=this._items[t],r=n.amt<10?" "+n.amt:n.amt;e[t]=n.name+":"+r}return e},_getFlags:function(){return _.map(this._items,function(e,t){return!e.canUse})},callback:function(e){var t=this._items[e];this.clear();var n=Mr.items[t.id];n.use(on),on.removeFromInventory(t.id),hn.setMonsterWillAttack(!0)}}),yt=b.extend({_init:function(e,t){this._battle=t,this._parent=e;var n=Qt.width,r=Qt.height;this._spells=[];var i=this._getSpells(),s=this._getTexts(),o=this.createCallbacks(i),u=this;this._super({type:Et,numberSelections:i,drawBox:!1,left:133,top:r-150,width:n-133,height:150,radius:15,thickness:3,pointerLeft:154,textLeft:180,heights:[r-132,r-110,r-86,r-62,r-38],texts:s,font:"bold 16px sans-serif",callbacks:o,canESC:!0,afterCallback:function(){u._parent.returnTo(!0)},afterClear:function(){u._parent.returnTo(!0)}})},_getSpells:function(){var e=0,t=this;return on.forEachSpell(function(n){var r={};r.name=Fr.spells[n].name,r.type=Fr.spells[n].type,r.id=n,r.canUse=!0,t._spells.push(r),e++}),e},_getTexts:function(){var e=[];for(var t=0;t<this._spells.length;++t){var n=this._spells[t];e[t]=n.name}return e},callback:function(e){var t=this._spells[e];this.clear();var n=Fr.spells[t.id];if(on.getMP()>=n.mpCost){switch(t.type){case Pr:n.use(on);break;case Hr:n.use()}on.useMP(parseInt(n.mpCost)),hn.setMonsterWillAttack(!0)}else this._battle.writeMsg("You do not have enough MP"),this._battle.writeMsg("to cast "+t.name+"."),hn.setMonsterWillAttack(!1)}}),bt=0,wt=1,Et=2,St=3,xt=0,Tt=1,Nt=2,Ct=3,kt=4,Lt=4,At=b.extend({_init:function(e){var t=this;this._battle=e;var n=Qt.height;this._texts1=["Attack","Defend","Spell","Item"],this._super({type:bt,numberSelections:Lt,drawBox:!0,left:0,top:n-150,width:140,height:150,radius:15,thickness:3,pointerLeft:16,textLeft:36,heights:[n-130,n-100,n-70,n-40],texts:this._texts1,font:"bold 20px monospace",callbacks:[function(){t._battle.beginAttack()},function(){t._battle.defend()},function(){t.displaySpellMenu()},function(){t.displayItemMenu()},function(){t._battle.run()}],canESC:!1}),this._texts2=["Run"],this._currentMenu=this},getCurrentMenu:function(){return this._currentMenu},setCurrentMenu:function(e){this._currentMenu=e},returnTo:function(e){this._currentMenu=this,this.drawPointer(),e&&(this._battle.clearText(),this._battle.drawText())},setDisplayed:function(e){this._displayed=e},displayItemMenu:function(){this._battle.clearText();var e=new gt(this,this._battle);e.display(),this._currentMenu=e,this._battle.setMonsterWillAttack(!1)},displaySpellMenu:function(){this._battle.clearText();var e=new yt(this,this._battle);e.display(),this._currentMenu=e,this._battle.setMonsterWillAttack(!1)},handleKey:function(e){if(this._currentMenu==this){if(this._displayed){this.clearPointer();switch(e){case Sn:this._current++,this._current%=this._num;break;case xn:this._current--,this._current<0&&(this._current+=this._num);break;case Nn:case Tn:this._texts==this._texts1?(this._texts=this._texts2,this._num=1,this._savedCurrent=this._current,this._current=0,this.clear(),this.display()):(this._texts=this._texts1,this._num=Lt,this._current=this._savedCurrent,this.clear(),this.display())}this.drawPointer()}}else this._currentMenu.handleKey(e)},handleEnter:function(){this._currentMenu==this?this._texts==this._texts1?this._callbacks[this._current]():this._callbacks[kt]():this._currentMenu.handleEnter()},handleESC:function(){this._currentMenu==this&&this._canESC?this._super():this._currentMenu.handleESC()}}),at=0,ft=1,lt=2,ht=0,pt=1,dt=2,Ot=Class.extend({_init:function(){this._shopDisplayed=!1,this._quantity=1,this._maxquantity=99,this._price=0,this._quantityDisplayed=!1,this._toDisplayQuantity=!1},shopDisplayed:function(){return this._menu&&this._menu.isDisplayed()},getItemList:function(){return this._itemList},displayShop:function(e,t){this._itemList=e,this._toDisplayQuantity=t,this._menu=new vt(this),this._menu.display()},displayQuantityDialog:function(e){this._quantity=1;var t;this._menu.getCurrentMenu().getType()==ft?(t=e.cost,this._maxQuantity=99):this._menu.getCurrentMenu().getType()==lt&&(t=e.sellPrice,this._maxQuantity=e.amt),this._price=t,wn(tn,100,250,300,50,10,3),rn.font="bold 16px monospace",rn.fillStyle="white",rn.textBaseline="top",rn.fillText("Quantity: "+this._quantity+"  Cost: "+this._quantity*t+"G",120,266),this._item=e,this._quantityDisplayed=!0},clearQuantityDialog:function(){tn.clearRect(100,250,300,50),rn.clearRect(100,250,300,50),this._quantityDisplayed=!1},isQuantityDialogDisplayed:function(){return this._quantityDisplayed},increaseQuantity:function(){this._quantity<this._maxQuantity&&this._quantity++,rn.clearRect(100,250,300,50),rn.fillText("Quantity: "+this._quantity+"  Cost: "+this._quantity*this._price+"G",120,266)},decreaseQuantity:function(){this._quantity>1&&this._quantity--,rn.clearRect(100,250,300,50),rn.fillText("Quantity: "+this._quantity+"  Cost: "+this._quantity*this._price+"G",120,266)},handleKey:function(e){if(this._quantityDisplayed)switch(e){case xn:case Nn:this.increaseQuantity();break;case Tn:case Sn:this.decreaseQuantity()}else this._menu.isDisplayed()&&this._menu.handleKey(e)},handleEnter:function(){if(this._quantityDisplayed){var e=this._menu.getCurrentMenu().getType();this._menu.handleESC(),e==ft?this.buyItems():e==lt&&this.sellItems()}else this._menu.isDisplayed()&&this._menu.handleEnter()},handleESC:function(){this._quantityDisplayed?this.clearQuantityDialog():this._menu.isDisplayed()&&this._menu.handleESC()},handlePurchase:function(e){this._toDisplayQuantity?this.displayQuantityDialog(e):this.buyItem(e)},handleSale:function(e){e.amt>1?this.displayQuantityDialog(e):(this._menu.getCurrentMenu().clear(),this.sellItem(e))},buyItem:function(e){var t=on.getGold();t>=e.cost?(on.spendGold(e.cost),on.addToInventory(e.id,1),fn.displayText("You purchased 1 "+e.name+" for "+e.cost+"G."),this._menu.clearGold(),this._menu.displayGold()):fn.displayText("You do not have enough gold\nto buy a "+e.name+".\nYou only have "+t+"G.")},buyItems:function(){this.clearQuantityDialog();var e=this._item,t=on.getGold(),n=e.cost*this._quantity;t>=n?(on.spendGold(n),on.addToInventory(e.id,this._quantity),fn.displayText("You purchased "+this._quantity+" "+e.name+"s for "+n+"G."),this._menu.clearGold(),this._menu.displayGold()):fn.displayText("You do not have enough gold\nto buy "+this._quantity+" "+e.name+"s.\nYou only have "+t+"G.")},sellItem:function(e){on.removeFromInventory(e.id),on.earnGold(e.sellPrice),this._menu.clearGold(),this._menu.displayGold(),fn.displayText("You sold 1 "+e.name+" for "+e.sellPrice+"G.")},sellItems:function(){this.clearQuantityDialog();var e=this._item,t=e.sellPrice*this._quantity;on.removeFromInventory(e.id,this._quantity),on.earnGold(t),this._menu.clearGold(),this._menu.displayGold(),fn.displayText("You sold "+this._quantity+" "+e.name+"s for "+t+"G.")}}),Mt=Class.extend({_init:function(e){this._titlescreenImgRef=e,this._flags={},this._loadFunctions=[]},isFlagSet:function(e){return!!this._flags[e]},setFlag:function(e){this._flags[e]=!0},addLoadFunction:function(e){this._loadFunctions.push(e)},save:function(e){amplify.store("save"+e,{version:Ht,timestamp:(new Date).toString(),player:on.createSaveData(),worldmap:un.createSaveData(),game:this.createSaveData()})},load:function(e){var t=amplify.store("save"+e);if(!t)throw new _t;if(t.version!=Ht)throw new Dt;on.loadSaveData(t.player),un.loadSaveData(t.worldmap),this.loadSaveData(t.game);for(var n=0;n<this._loadFunctions.length;++n)this._loadFunctions[n]()},reset:function(){this._flags={};for(var e=0;e<this._loadFunctions.length;++e)this._loadFunctions[e]();on.reset()},showTitleScreen:function(){Gt.drawImage(Bn.images[this._titlescreenImgRef].img,0,0),ln.setCurrentMenu(new F(ln))},hasSaveInfo:function(e){return!!amplify.store("save"+e)},getSaveInfo:function(e){var t=new Date(amplify.store("save"+e).timestamp);return dateFormat(t,"ddd, mmm d h:MM TT")},createSaveData:function(){return this._flags},loadSaveData:function(e){this._flags=e}}),_t=Class.extend({}),Dt=Class.extend({}),Pt=Class.extend({_init:function(){this._background=null,this._encounter=null,this._monsterList=null,this._currentAction=xt,this._mainMenu=new At(this),this._currentMenu=this._mainMenu,this._over=!1,this._win=!1,this._line=0,this._txt="",this._totalExp=0,this._totalGold=0,this._monsterWillAttack=!0,this._defending=!1,this._ignoringKeys=!1,this._writing=!1,this._delay=0;var e=Qt.height;this._textHeight=[e-132,e-110,e-86,e-62,e-38]},setupRandomEncounter:function(e,t){this._background=Bn.images[t].img;var n=null;for(var r=0;r<_r.zones.length;++r)_r.zones[r].zone==e&&(n=_r.zones[r]);if(n!=null){var i=n.encounters.length,s=Math.floor(Math.random()*i);this._encounter=n.encounters[s],this._monsterList=[];for(var o=0;o<this._encounter.monsters.length;++o){var u=this._encounter.monsters[o];for(var a=0;a<Dr.monsters.length;++a)if(Dr.monsters[a].id==u){var f=new v(Dr.monsters[a]);this._monsterList.push(f)}}}On&&(this._ignoringKeys=!0)},setupEncounter:function(e,t,n){this._background=Bn.images[n].img,this._encounter={name:e,monsters:t},this._monsterList=[];for(var r=0;r<t.length;++r){var i=t[r];for(var s=0;s<Dr.monsters.length;++s)if(Dr.monsters[s].id==i){var o=new v(Dr.monsters[s]);this._monsterList.push(o)}}On&&(this._ignoringKeys=!0)},draw:function(){var e=Qt.width,t=Qt.height;Gt.drawImage(this._background,0,0,e,t),Zt.clearRect(0,0,e,t),this.drawPlayer(),this.drawHealthBar(),this.drawManaBar(),this.drawMonsters(),this._mainMenu.display(),wn(tn,133,t-150,e-133,150,15,3),rn.font="bold 16px sans-serif";var n=this._encounter.name+" appeared!";rn.fillText(n,154,this._textHeight[0]),this._line=1,this._txt=n},drawPlayer:function(){Zt.drawImage(on._img,Wt,h*Xt,Wt,Xt,Yt.width-3*Bt,2*jt,Wt,Xt)},clearPlayer:function(){Zt.clearRect(Yt.width-3*Bt,2*jt,Wt,Xt)},drawMonsters:function(){var e=2*Bt;for(var t=0;t<this._monsterList.length;++t){var n=this._monsterList[t],r=Bn.images[n.getImageRef()].img;Zt.drawImage(r,n.getLeft(),n.getTop(),n.getWidth(),n.getHeight(),e,3*jt,n.getWidth(),n.getHeight()),n.setLoc(e),e+=n.getWidth()+15}},clearMonster:function(e){var t=this._monsterList[e];Zt.clearRect(t.getLoc(),3*jt,t.getWidth(),t.getHeight())},drawHealthBar:function(){var e=Yt.width-2*Bt+.5,t=2*jt+.5,n=10,r=Xt,i=on.getHP()/on.getMaxHP();i<0&&(i=0);var s=t+Math.round((1-i)*r),o=r-(s-t);Zt.fillStyle="red",Zt.fillRect(e,s,n,o),Zt.strokeStyle="black",Zt.strokeRect(e,t,n,r)},drawManaBar:function(){var e=Yt.width-2*Bt+10.5,t=2*jt+.5,n=10,r=Xt,i=on.getMP()/on.getMaxMP();i<0&&(i=0);var s=t+Math.round((1-i)*r),o=r-(s-t);Zt.fillStyle="#ccccff",Zt.fillRect(e,s,n,o),Zt.strokeStyle="black",Zt.strokeRect(e,t,n,r)},clearHealthBar:function(){var e=Yt.width-2*Bt+.5,t=2*jt+.5,n=10,r=Xt;Zt.clearRect(e,t,n,r)},clearManaBar:function(){var e=Yt.width-2*Bt+10.5,t=2*jt+.5,n=10,r=Xt;Zt.clearRect(e,t,n,r)},updateHealthBar:function(e){this.clearHealthBar();var t=Yt.width-2*Bt+.5,n=2*jt+.5,r=10,i=Xt,s=e/on.getMaxHP();s<0&&(s=0);var o=n+Math.round((1-s)*i),u=i-(o-n);Zt.fillStyle="red",Zt.fillRect(t,o,r,u),Zt.strokeStyle="black",Zt.strokeRect(t,n,r,i)},writeMsg:function(e){this._writing=!0,this._mainMenu.clearPointer(),window.setTimeout(function(){hn.drawText();var t=hn._line<=4?hn._line:4;rn.fillText(e,154,hn._textHeight[t]),hn._txt+="\n"+e,hn._line++,hn._delay-=Kt,hn._delay==0&&(hn._writing=!1,hn._over||hn._mainMenu.drawPointer())},this._delay),this._delay+=Kt},drawText:function(){rn.font="bold 16px sans-serif",rn.fillStyle="white",rn.textBaseline="top",this.clearText();var e=this._txt.split("\n");if(this._line<=4)for(var t=0;t<this._line;++t)rn.fillText(e[t],154,this._textHeight[t]);else for(var t=0;t<4;++t){var n=e[e.length-4+t];rn.fillText(n,154,this._textHeight[t])}},clearText:function(){rn.clearRect(154,this._textHeight[0],nn.width-154,nn.height-this._textHeight[0])},end:function(){tn.clearRect(0,0,en.width,en.height),Zt.clearRect(0,0,Yt.width,Yt.height),rn.clearRect(0,0,nn.width,nn.height),on.isDead()?(an=!0,sn.showTitleScreen()):(un.redraw(),un.drawSprites(),on.plot(),this._win&&this.onWin(),this.onExit()),hn=null},handleKey:function(e){!this._writing&&!this._ignoringKeys&&!this.over&&!on.isDead()&&this._currentMenu.handleKey(e)},handleEnter:function(){!this._writing&&!on.isDead()&&(this._over?this.end():(this._defending=!1,this._monsterWillAttack=!0,this._currentMenu.handleEnter(),this.finishTurn()))},handleESC:function(){this._over?this.end():this._currentMenu.handleESC()},handleKeyUp:function(){this._ignoringKeys=!1},setMonsterWillAttack:function(e){this._monsterWillAttack=e},beginAttack:function(){this._currentAction=xt,this._monsterList.length==1?(this.attack(0),this.finishTurn()):(this._currentMenu=new mt(this._currentMenu,this,this._monsterList),this._currentMenu.selectFirstLiveMonster(),this._currentMenu.display(),this._monsterWillAttack=!1)},defend:function(){this._defending=!0,this.writeMsg("You defended."),this.finishTurn()},finishTurn:function(){!this._over&&this._monsterWillAttack&&this.monsterTurn(!1),this._monsterWillAttack&&this.runAfterWriting(function(){hn.clearHealthBar(),hn.clearManaBar(),hn.drawHealthBar(),hn.drawManaBar(),hn._over||(hn._currentMenu=hn._mainMenu,hn._mainMenu.returnTo(!1))}),this._defending=!1,this._monsterWillAttack=!1},runAfterWriting:function(e){this._writing?window.setTimeout(function(){hn.runAfterWriting(e)}):e()},forEachMonster:function(e){for(var t=0;t<this._monsterList.length;++t)this._monsterList[t].isDead()||e(this._monsterList[t],t)},earnReward:function(e,t){var n=this;window.setTimeout(function(){n.clearMonster(t)},this._delay),this.writeMsg("The "+e.getName()+" was killed."),this._totalExp+=e.getExp(),this._totalGold+=e.getGold();for(var r=0;r<this._monsterList.length;++r)if(!this._monsterList[r].isDead())return;on.earnGold(this._totalGold);var i=on.earnExp(this._totalExp);this.writeMsg("You have earned "+this._totalExp+" exp"),this.writeMsg("and "+this._totalGold+" GP."),i&&this.writeMsg("You gained a level!"),this._over=!0,this._win=!0,this._mainMenu.clearPointer()},doActionToMonster:function(e){switch(this._currentAction){case xt:this.attack(e),this.finishTurn();break;case Tt:this._defending=!0;break;case Ct:break;case Nt:break;case kt:}},attack:function(e){var t=this._monsterList[e],n=Math.random();if(n>.95)this.writeMsg("You missed!");else{var r=on.getAttack()-t.getDefense();n>.9&&(this.writeMsg("Critical Hit!"),r*=2),r<1&&(r=1),r-=Math.floor(Math.random()*r/2),this.writeMsg("You attacked for "+r+" damage."),t.damage(r),t.isDead()&&this.earnReward(t,e)}},monsterTurn:function(){for(var e=0;e<this._monsterList.length;++e){var t=this._monsterList[e];if(!t.isDead()){if(t.hasSpecialAttack()&&Math.random()<.5)t.useSpecialAttack();else{var n=Math.random();if(n>.9)this.writeMsg("The "+t.getName()+" missed!");else{var r=t.getAttack()-on.getDefense();n>.86&&(this.writeMsg("Terrible Hit!"),r=2*t.getAttack()-on.getDefense()),this._defending&&(r=Math.floor(r/2.5)),r<1&&(r=1),r-=Math.floor(Math.random()*r/2),on.damage(r),this.writeMsg("The "+t.getName()+" attacked for"),this.writeMsg(r+" damage.");var i=this,s=on.getHP();window.setTimeout(function(e){return function(){i.updateHealthBar(e)}}(s),this._delay)}}if(on.isDead()){this.writeMsg("You died."),this._over=!0,this._mainMenu.clearPointer();var i=this;this.runAfterWriting(function(){i.clearPlayer()});return}}}},run:function(){if(Math.random()>=.33){this.writeMsg("You start to run."),this.monsterTurn(!1);if(on.isDead()||this._over)return!1;if(Math.random()<.33)return this.writeMsg("You couldn't run away."),!1}this.writeMsg("You ran away."),this._over=!0,this._mainMenu.clearPointer();var e=this;return this.runAfterWriting(function(){e.clearPlayer()}),!0},useItem:function(){if(this._itemSelection<this._numItems){var e=this._itemId[this._itemSelection],t=Mr.items[e];switch(t.type){case Yn:t.use(on);break;case Zn:t.use()}return on.removeFromInventory(e),!0}return!1},useSpell:function(){if(this._spellSelection<this._numSpells){var e=this._spellId[this._spellSelection],t=Fr.spells[e];if(on.getMP()>=t.mpCost){switch(t.type){case Pr:t.use(on);break;case Hr:t.use()}return on.useMP(t.mpCost),!0}this.writeMsg("You do not have enough MP"),this.writeMsg("to cast "+t.name+".")}return!1},onExit:function(){},onWin:function(){}}),Ht="0.1pre 20130317",Bt=32,jt=32,Ft=13,It=11,qt=5,Rt=7,Ut=4,zt=6,Wt=32,Xt=48,Vt=25,$t=4,Jt=.14,Kt=500,Qt=document.getElementById("mapCanvas"),Gt=Qt.getContext("2d"),Yt=document.getElementById("spriteCanvas"),Zt=Yt.getContext("2d"),en=document.getElementById("menuCanvas"),tn=en.getContext("2d"),nn=document.getElementById("textCanvas"),rn=nn.getContext("2d"),sn=null,on=null,un=null,an=!0,fn=new g,ln=new rt,cn=new Ot,hn=null,pn=!1,dn=new n,vn=[Qt,Yt,en,nn,document.getElementById("gamepad")];Object.keys||(Object.keys=function(e){var t=new Array;for(var n in e)e.hasOwnProperty(n)&&t.push(n);return t}),$(document).ready(function(){dn.onComplete=function(){document.getElementById("loaded").innerHTML="Loading Complete!"},dn.onFail=function(){var e="One or more resource(s) was not loaded:<br>",t=dn.getList();for(var n=0;n<t.length;++n)e+=t[n]+"<br>";document.getElementById("loaded").innerHTML=e},sn=new Mt("titlescreen"),gn(),yn()});var Sn=40,xn=38,Tn=37,Nn=39,Cn=32,kn=13,Ln=27,An=0,On=!1;window.opera||$.browser.mozilla?$(window).keypress(Mn):$(window).keydown(Mn),$(window).keyup(_n),$(document).ready(function(){var e=document.getElementById("showpad");e.onclick=function(){if(e.innerHTML=="Show Gamepad"){var t=document.getElementById("gamepad");t.style.display="block",e.innerHTML="Hide Gamepad";var n=document.getElementById("nokeyb");n.style.display="none"}else{var t=document.getElementById("gamepad");t.style.display="none",e.innerHTML="Show Gamepad";var n=document.getElementById("nokeyb");n.style.display="inline"}};var t=document.getElementById("upButton");t.onclick=function(e){Dn(xn,e)};var n=document.getElementById("downButton");n.onclick=function(e){Dn(Sn,e)};var r=document.getElementById("leftButton");r.onclick=function(e){Dn(Tn,e)};var i=document.getElementById("rightButton");i.onclick=function(e){Dn(Nn,e)};var s=document.getElementById("escButton");s.onclick=function(e){Dn(Ln,e)};var o=document.getElementById("enterButton");o.onclick=function(e){Dn(kn,e)}}),$(window).dblclick(function(e){pn=!pn,Hn(),e.preventDefault()}),$(window).resize(function(){pn&&Hn()});var Bn={images:{titlescreen:{url:"images/titlescreen.png",load:function(){sn.showTitleScreen()}},pointer:{url:"images/pointer.png"},world:{url:"images/World3.png"},trevor:{url:"images/Trevor.png"},meadow:{url:"images/meadow.png"},forestbk:{url:"images/darkforest.png"},InqCastle:{url:"images/InqCastle.png"},forest:{url:"images/Dark_Forest.png"},enemies:{url:"images/enemies-t2.png"},chest:{url:"images/Chest2.png"},soldier:{url:"images/Soldier2.png"},InqIndoors:{url:"images/Inq_XP_Medieval_Indoors.png"},BrowserQuest:{url:"images/BrowserQuest2.png"},man1:{url:"images/Man1.png"},man2:{url:"images/Man2.png"},woman1:{url:"images/Woman1.png"},woman2:{url:"images/Woman2.png"},boy:{url:"images/Boy.png"}}},jn=0,Fn=1,In=2,qn=3,Rn=4,Un=5,zn=6,Wn=7,Xn=8,Vn=9,$n=10,Jn=11,Kn=12,Qn={submaps:{0:{id:jn,tileset:{imgRef:"world",width:256,height:1152},xmlUrl:"xml/WorldMap1.tmx.xml",randomEncounters:!0,background:"meadow",overWorld:!0,load:function(){on=new d(23,13,"trevor",0,c,Ir),ln.setOnNewGame(function(){un.goToMap(on,0,23,13,17,8,c)})},entrances:[{fromX:23,fromY:14,toMapId:Xn,toX:9,toY:18,toScrollX:4,toScrollY:9,facing:f,onEnter:function(){on.restore()}},{fromX:13,fromY:9,toMapId:qn,toX:9,toY:28,toScrollX:3,toScrollY:19,facing:f}]},9:{id:Vn,tileset:{imgRef:"InqIndoors",width:256,height:8704},xmlUrl:"xml/House11.tmx.xml",randomEncounters:!1,overWorld:!1,exit:{at:"bottom",toMapId:Xn,toX:1,toY:6,toScrollX:0,toScrollY:2,facing:c}},10:{id:$n,tileset:{imgRef:"InqIndoors",width:256,height:8704},xmlUrl:"xml/House2.tmx.xml",randomEncounters:!1,overWorld:!1,exit:{at:"bottom",toMapId:Xn,toX:15,toY:7,toScrollX:7,toScrollY:2,facing:c}},11:{id:Jn,tileset:{imgRef:"InqIndoors",width:256,height:8704},xmlUrl:"xml/House3.tmx.xml",randomEncounters:!1,overWorld:!1,exit:{at:"bottom",toMapId:Xn,toX:2,toY:16,toScrollX:0,toScrollY:9,facing:c},npcs:[{imgRef:"woman1",locX:5,locY:4,facing:l,displayText:"My husband has not returned yet. It has \nbeen three days since he left for the \ndark forest.",walks:!1}]},12:{id:Kn,tileset:{imgRef:"InqIndoors",width:256,height:8704},xmlUrl:"xml/House4.tmx.xml",randomEncounters:!1,overWorld:!1,exit:{at:"bottom",toMapId:Xn,toX:17,toY:16,toScrollX:7,toScrollY:9,facing:c},npcs:[{imgRef:"boy",locX:11,locY:12,facing:l,displayText:"When I am not doing chores, I enjoy a \ngood read.",walks:!1},{imgRef:"woman1",locX:2,locY:6,facing:f,displayText:"Do you need help finding a book?",walks:!1},{imgRef:"man1",locX:13,locY:7,facing:f,displayText:"Our town is small yet humble.",walks:!1},{imgRef:"woman2",locX:2,locY:11,facing
:h,displayText:"Despite being new, this library is full \nof books!",walks:!1},{imgRef:"man2",locX:7,locY:3,facing:f,displayText:"Boy, the King sure did let himself go....",walks:!1}]},8:{id:Xn,tileset:{imgRef:"BrowserQuest",width:256,height:2560},xmlUrl:"xml/Town3.tmx.xml",randomEncounters:!1,overWorld:!0,entrances:[{fromX:1,fromY:5,toMapId:Vn,toX:7,toY:13,toScrollX:2,toScrollY:4,facing:f},{fromX:15,fromY:6,toMapId:$n,toX:6,toY:13,toScrollX:0,toScrollY:4,facing:f},{fromX:2,fromY:15,toMapId:Jn,toX:7,toY:13,toScrollX:2,toScrollY:4,facing:f},{fromX:17,fromY:15,toMapId:Kn,toX:6,toY:13,toScrollX:1,toScrollY:4,facing:f},{fromX:9,fromY:0,toMapId:Fn,toX:12,toY:17,toScrollX:6,toScrollY:9,facing:f},{fromX:10,fromY:0,toMapId:Fn,toX:12,toY:17,toScrollX:6,toScrollY:9,facing:f}],exit:{at:"bottom",toMapId:jn,toX:23,toY:14,toScrollX:17,toScrollY:9,facing:c},npcs:[{imgRef:"woman1",locX:2,locY:8,facing:c,displayText:"Our town is small, but we manage to get \nby.",walks:!1},{imgRef:"boy",locX:7,locY:15,facing:l,displayText:"My older brother went to the forest to \nlook for my father, but they have not \nreturned yet...sniff.",walks:!0},{imgRef:"man1",locX:8,locY:2,facing:l,displayText:"Welcome to the town of (Town name).",walks:!1},{imgRef:"soldier",locX:12,locY:18,facing:h,displayText:"The king is recruiting all able men to \nvanquish the terror within the forest.",walks:!1}]},6:{id:zn,tileset:{imgRef:"InqIndoors",width:256,height:8704},xmlUrl:"xml/Library.tmx.xml",randomEnounters:!1,overWorld:!1,exit:{at:"bottom",toMapId:Rn,toX:9,toY:5,toScrollX:4,toScrollY:0,facing:c},npcs:[{imgRef:"man1",locX:3,locY:8,facing:f,displayText:"Knowing when to flee can be crucial to \nfighting another day.",walks:!1},{imgRef:"boy",locX:6,locY:17,facing:h,displayText:"Be sure to save often and watch your \nhealth.",walks:!1},{imgRef:"soldier",locX:16,locY:8,facing:f,displayText:"Gaining experience will make you strong \nlike me! Bwahahaha! *cough* *wheeze*",walks:!1}]},5:{id:Un,tileset:{imgRef:"InqIndoors",width:256,height:8704},xmlUrl:"xml/Armory.tmx.xml",randomEncounters:!1,overWorld:!1,exit:{at:"bottom",toMapId:Rn,toX:2,toY:5,toScrollX:0,toScrollY:0,facing:c},chests:[{imgRef:"chest",locX:4,locY:8,event:"ac1",action:function(){this.onOpenFindItem("You found 2 potions.",ir,2)}},{imgRef:"chest",locX:2,locY:9,event:"ac2",action:function(){this.onOpenFindItem("You found 1 potion.",ir,1)}},{imgRef:"chest",locX:12,locY:6,event:"ac3",action:function(){this.onOpenFindGold(30)}}]},7:{id:Wn,tileset:{imgRef:"InqIndoors",width:256,height:8704},xmlUrl:"xml/Infirmary.tmx.xml",randomEncounters:!1,overWorld:!1,exit:{at:"bottom",toMapId:Rn,toX:16,toY:5,toScrollX:7,toScrollY:0,facing:c},npcs:[{imgRef:"woman1",locX:18,locY:17,facing:h,displayText:"Would you like to rest here?",walks:!1},{imgRef:"soldier",locX:3,locY:8,facing:f,displayText:"I want to challenge the Rat King again, \nbut I still can't move...",walks:!1},{imgRef:"soldier",locX:13,locY:8,facing:l,displayText:"The King is looking for a powerful hero to \ndefeat the treacherous Rat King.",walks:!1},{imgRef:"boy",locX:3,locY:17,facing:l,displayText:"If I was a little older, I would join \nthe knights and make a difference.",walks:!1}],actions:[{locX:16,locY:17,dir:l,onAction:function(){Qn.submaps[Wn].npcs[0].npc.action()}}]},4:{id:Rn,tileset:{imgRef:"InqIndoors",width:256,height:8704},xmlUrl:"xml/CastleRoom.tmx.xml",randomEncounters:!1,overWorld:!1,entrances:[{fromX:2,fromY:4,toMapId:Un,toX:9,toY:18,toScrollX:4,toScrollY:9,facing:f},{fromX:3,fromY:4,toMapId:Un,toX:10,toY:18,toScrollX:4,toScrollY:9,facing:f},{fromX:9,fromY:4,toMapId:zn,toX:10,toY:17,toScrollX:4,toScrollY:9,facing:f},{fromX:10,fromY:4,toMapId:zn,toX:10,toY:17,toScrollX:4,toScrollY:9,facing:f},{fromX:16,fromY:4,toMapId:Wn,toX:9,toY:17,toScrollX:4,toScrollY:9,facing:f},{fromX:17,fromY:4,toMapId:Wn,toX:10,toY:17,toScrollX:4,toScrollY:9,facing:f}],exit:{at:"bottom",toMapId:In,toX:10,toY:18,toScrollX:4,toScrollY:9,facing:f},npcs:[{imgRef:"soldier",locX:6,locY:16,facing:c,displayText:"Welcome to the main floor.",walks:!1},{imgRef:"soldier",locX:13,locY:16,facing:c,displayText:"Feel free to have a look around.",walks:!1},{imgRef:"soldier",locX:1,locY:5,facing:c,displayText:"Help yourself to the items in the Armory.",walks:!1},{imgRef:"soldier",locX:15,locY:5,facing:l,displayText:"The Infirmary gets more crowded day by \nday due to the monsters...",walks:!1},{imgRef:"woman2",locX:11,locY:5,facing:h,displayText:"There are so many books in the library,\nI could spend an eternity there!",walks:!1}]},1:{id:Fn,tileset:{imgRef:"InqCastle",width:256,height:2304},xmlUrl:"xml/Castle1.tmx.xml",randomEncounters:!1,overWorld:!1,entrances:[{fromX:11,fromY:12,toMapId:In,toX:10,toY:18,toScrollX:4,toScrollY:9,facing:f},{fromX:12,fromY:12,toMapId:In,toX:10,toY:18,toScrollX:4,toScrollY:9,facing:f},{fromX:13,fromY:12,toMapId:In,toX:10,toY:18,toScrollX:4,toScrollY:9,facing:f}],exit:{at:"edges",toMapId:Xn,toX:9,toY:1,toScrollX:4,toScrollY:0,facing:c},npcs:[{imgRef:"soldier",locX:10,locY:14,facing:c,displayText:"You may enter the castle now.",walks:!1},{imgRef:"soldier",locX:14,locY:14,facing:c,displayText:"But the interior is still under\nconstruction.",walks:!1}]},2:{id:In,tileset:{imgRef:"InqIndoors",width:256,height:8704},xmlUrl:"xml/CastleShops.tmx.xml",randomEncounters:!1,overWorld:!1,entrances:[{fromX:9,fromY:15,toMapId:Rn,toX:10,toY:18,toScrollX:4,toScrollY:9,facing:f},{fromX:10,fromY:15,toMapId:Rn,toX:10,toY:18,toScrollX:4,toScrollY:9,facing:f},{fromX:11,fromY:15,toMapId:Rn,toX:10,toY:18,toScrollX:4,toScrollY:9,facing:f},{fromX:8,fromY:15,toMapId:Rn,toX:10,toY:18,toScrollX:4,toScrollY:9,facing:f}],exit:{at:"bottom",toMapId:Fn,toX:12,toY:12,toScrollX:6,toScrollY:7,facing:c},npcs:[{imgRef:"man1",locX:1,locY:8,facing:l,displayText:"Welcome to the weapon shop.",callback:function(){cn.displayShop([lr,cr,hr,pr],!1)},walks:!1},{imgRef:"man2",locX:18,locY:8,facing:h,displayText:"Welcome to the armor shop.",callback:function(){cn.displayShop([gr,yr,br,Sr,xr,Tr,kr,Lr,Ar],!1)},walks:!1},{imgRef:"woman2",locX:1,locY:12,facing:l,displayText:"Welcome to the item shop.",callback:function(){cn.displayShop([ir,ur,ar,sr,or],!0)},walks:!1},{imgRef:"woman1",locX:10,locY:12,facing:c,displayText:"Welcome to the castle's tavern.",walks:!0},{imgRef:"boy",locX:16,locY:17,facing:h,displayText:"Whenever I return to the castle,\nI feel completely refreshed and\nrestored.",walks:!0}],actions:[{locX:3,locY:8,dir:h,onAction:function(){Qn.submaps[In].npcs[0].npc.action()}},{locX:16,locY:8,dir:l,onAction:function(){Qn.submaps[In].npcs[1].npc.action()}},{locX:3,locY:12,dir:h,onAction:function(){Qn.submaps[In].npcs[2].npc.action()}}]},3:{id:qn,tileset:{imgRef:"forest",width:256,height:576},xmlUrl:"xml/Forest1.tmx.xml",randomEncounters:!0,zone:"forest",background:"forestbk",overWorld:!1,load:function(){var e=qn,t=un.getSubMap(e),n=new u(11,7,32,58,"enemies",e,664,249);n.action=function(){fn.setCallback(function(){An=0,hn=new Pt,hn.setupEncounter("A rat king",[10],"forestbk"),hn.onWin=function(){sn.setFlag("fb"),n.clear(),t.removeSprite(n)},hn.draw()}),fn.displayText("I am the rat king.\nI rule this domain.\nPrepare to die.")},t.addSprite(n),sn.addLoadFunction(function(){sn.isFlagSet("fb")?(n.clear(),t.removeSprite(n)):t.hasSprite(n)||t.addSprite(n)})},exit:{at:"bottom",toMapId:jn,toX:13,toY:9,toScrollX:7,toScrollY:4,facing:c},chests:[{imgRef:"chest",locX:3,locY:27,event:"fc1",action:function(){this.onOpenFindItem("You found 5 potions.",ir,5)}},{imgRef:"chest",locX:17,locY:11,event:"fc2",action:function(){this.onOpenFindItem("You found 3 bombs.",sr,3)}},{imgRef:"chest",locX:16,locY:2,event:"fc3",action:function(){this.onOpenLearnSpell(Br)}},{imgRef:"chest",locX:3,locY:7,event:"fc4",action:function(){this.onOpenLearnSpell(jr)}}]}}},Gn=.75,Yn=1,Zn=4,er=5,tr=6,nr=7,rr=8,ir=0,sr=1,or=2,ur=3,ar=4,fr=10,lr=11,cr=12,hr=13,pr=14,dr=15,vr=16,mr=20,gr=21,yr=22,br=23,wr=24,Er=30,Sr=31,xr=32,Tr=33,Nr=34,Cr=40,kr=41,Lr=42,Ar=43,Or=44,Mr={items:{0:{id:ir,name:"Potion",type:Yn,cost:15,usable:!0,use:function(e){var t=100+Math.floor(Math.random()*100);e.heal(t),bn(e.getName()+" healed for "+t+" points.")}},1:{id:sr,name:"Bomb",type:Zn,cost:35,usable:!0,use:function(){hn.forEachMonster(function(e,t){var n=50+Math.floor(Math.random()*100);n-=e.getDefense(),n<1&&(n=1),e.damage(n),hn.writeMsg("The "+e.getName()+" was hit for "),hn.writeMsg(n+" damage."),e.isDead()&&hn.earnReward(e,t)})}},2:{id:or,name:"Ether",type:Yn,cost:100,usable:!0,use:function(e){var t=25+Math.floor(Math.random()*25);e.gainMP(t),bn(e.getName()+" healed for "+t+" magic points.")}},3:{id:ur,name:"Max Potion",type:Yn,cost:1,usable:!0,use:function(e){var t=1e3+Math.floor(Math.random()*100);e.heal(t),bn(e.getName()+" healed for "+t+" points.")}},4:{id:ar,name:"Elixer",type:Yn,cost:1,usable:!0,use:function(e){var t=100+Math.floor(Math.random()*25);e.gainMP(t),bn(e.getName()+" healed for "+t+" magic points.")}},10:{id:fr,name:"Tin Sword",type:er,cost:10,usable:!1,attack:5},11:{id:lr,name:"Copper Sword",type:er,cost:30,usable:!1,attack:10},12:{id:cr,name:"Bronze Sword",type:er,cost:90,usable:!1,attack:15},13:{id:hr,name:"Iron Sword",type:er,cost:270,usable:!1,attack:20},14:{id:pr,name:"Steel Sword",type:er,cost:810,usable:!1,attack:25},15:{id:dr,name:"Broad Sword",type:er,cost:2430,usable:!1,attack:30},16:{id:vr,name:"Great Sword",type:er,cost:7290,usable:!1,attack:35},20:{id:mr,name:"Clothes",type:tr,cost:10,usable:!1,defense:1},21:{id:gr,name:"Leather Armor",type:tr,cost:50,usable:!1,defense:4},22:{id:yr,name:"Chain Mail",type:tr,cost:250,usable:!1,defense:7},23:{id:br,name:"Half Plate Mail",type:tr,cost:1250,usable:!1,defense:10},24:{id:wr,name:"Full Plate Mail",type:tr,cost:6250,usable:!1,defense:13},30:{id:Er,name:"Cap",type:nr,cost:5,usable:!1,defense:1},31:{id:Sr,name:"Leather Helmet",type:nr,cost:30,usable:!1,defense:2},32:{id:xr,name:"Bronze Helmet",type:nr,cost:150,usable:!1,defense:4},33:{id:Tr,name:"Iron Helmet",type:nr,cost:600,usable:!1,defense:6},34:{id:Nr,name:"Steel Helmet",type:nr,cost:1800,usable:!1,defense:8},40:{id:Cr,name:"Tin Shield",type:rr,cost:35,usable:!1,defense:1},41:{id:kr,name:"Copper Shield",type:rr,cost:90,usable:!1,defense:2},42:{id:Lr,name:"Bronze Shield",type:rr,cost:230,usable:!1,defense:4},43:{id:Ar,name:"Iron Shield",type:rr,cost:700,usable:!1,defense:6},44:{id:Or,name:"Steel Shield",type:rr,cost:2100,usable:!1,defense:8}}},_r={zones:[{zone:"1",encounters:[{name:"A slime",monsters:[0]},{name:"A rat",monsters:[1]},{name:"A snake",monsters:[2]},{name:"2 slimes",monsters:[0,0]},{name:"3 slimes",monsters:[0,0,0]},{name:"A rat and a slime",monsters:[1,0]}]},{zone:"2",encounters:[{name:"3 snakes",monsters:[2,2,2]},{name:"3 blue slimes",monsters:[3,3,3]},{name:"A red slime",monsters:[5]},{name:"2 red slimes",monsters:[5,5]},{name:"A cocatrice",monsters:[4]},{name:"A white rat",monsters:[6]}]},{zone:"3",encounters:[{name:"2 red slimes",monsters:[5,5]},{name:"3 red slimes",monsters:[5,5,5]},{name:"A cocatrice",monsters:[4]},{name:"A white rat",monsters:[6]},{name:"A cobra",monsters:[7]},{name:"A wolf",monsters:[8]}]},{zone:"4",encounters:[{name:"2 cobras",monsters:[7,7]},{name:"2 wolves",monsters:[8,8]},{name:"3 cocatrices",monsters:[4,4,4]},{name:"3 white rats",monsters:[6,6,6]},{name:"A wolf and a cobra",monsters:[8,7]},{name:"A mage",monsters:[9]}]},{zone:"5",encounters:[{name:"2 cobras",monsters:[7,7]},{name:"2 wolves",monsters:[8,8]},{name:"3 cocatrices",monsters:[4,4,4]},{name:"3 white rats",monsters:[6,6,6]},{name:"A wolf and a cobra",monsters:[8,7]},{name:"A mage",monsters:[9]}]},{zone:"6",encounters:[{name:"2 cobras",monsters:[7,7]},{name:"2 wolves",monsters:[8,8]},{name:"3 cocatrices",monsters:[4,4,4]},{name:"3 white rats",monsters:[6,6,6]},{name:"A wolf and a cobra",monsters:[8,7]},{name:"A mage",monsters:[9]}]},{zone:"forest",encounters:[{name:"3 rats",monsters:[1,1,1]},{name:"A blue slime",monsters:[3]},{name:"2 blue slimes",monsters:[3,3]},{name:"A snake",monsters:[2]},{name:"A snake and a rat",monsters:[2,1]},{name:"A cocatrice",monsters:[4]}]}]},Dr={monsters:[{id:0,name:"slime",hp:15,attack:10,defense:0,exp:5,gold:5,imgRef:"enemies",left:4,top:109,width:31,height:24},{id:1,name:"rat",hp:25,attack:15,defense:2,exp:10,gold:5,imgRef:"enemies",left:7,top:498,width:63,height:55},{id:2,name:"snake",hp:30,attack:20,defense:6,exp:15,gold:10,imgRef:"enemies",left:7,top:160,width:48,height:59},{id:3,name:"blue slime",hp:20,attack:20,defense:20,exp:20,gold:10,imgRef:"enemies",left:78,top:109,width:31,height:24},{id:4,name:"cocatrice",hp:45,attack:32,defense:16,exp:30,gold:30,imgRef:"enemies",left:14,top:329,width:47,height:67},{id:5,name:"red slime",hp:30,attack:30,defense:30,exp:30,gold:15,imgRef:"enemies",left:41,top:109,width:31,height:24},{id:6,name:"white rat",hp:55,attack:38,defense:20,exp:40,gold:30,imgRef:"enemies",left:145,top:498,width:63,height:55},{id:7,name:"cobra",hp:60,attack:42,defense:30,exp:40,gold:40,imgRef:"enemies",left:67,top:160,width:48,height:59},{id:8,name:"wolf",hp:68,attack:46,defense:28,exp:50,gold:25,imgRef:"enemies",left:7,top:685,width:47,height:55},{id:9,name:"mage",hp:100,attack:55,defense:20,exp:60,gold:40,imgRef:"enemies",left:640,top:153,width:32,height:33,special:function(e){var t=-1,n=9999;hn.writeMsg("The "+e.getName()+" casts Heal."),hn.forEachMonster(function(e,r){!e.isDead()&&e.getHP()<n&&(n=e.getHP(),t=r)});var r=hn._monsterList[t],i=50+Math.floor(Math.random()*50);r.heal(i),hn.writeMsg("The "+r.getName()+" was healed for "+i+".")}},{id:10,name:"rat king",hp:200,attack:55,defense:35,exp:120,gold:80,imgRef:"enemies",left:653,top:249,width:47,height:58}]},Pr=1,Hr=4,Br=0,jr=1,Fr={spells:[{id:Br,name:"Heal",mpCost:5,type:Pr,use:function(e){var t=100+Math.floor(Math.random()*100);e.heal(t),bn(e.getName()+" healed for "+t+" points.")}},{id:jr,name:"Bomb",mpCost:8,type:Hr,use:function(){hn.forEachMonster(function(e,t){var n=50+Math.floor(Math.random()*100);n-=e.getDefense(),n<1&&(n=1),e.damage(n),hn.writeMsg("The "+e.getName()+" was hit for "),hn.writeMsg(n+" damage."),e.isDead()&&hn.earnReward(e,t)})}}]},Ir=0,qr={players:[{id:0,name:"You",level:1,maxHP:100,maxMP:5,attack:12,defense:0,exp:0,gold:0,weapon:fr,armor:mr,helmet:Er,shield:Cr,inventory:[],spells:[],levels:[0,50,110,200,350,600,1e3,1500,2250,3375,5e3,7500,11250,16875,25e3,37500,56250,84375,126500,189750,284625,426900,640350,960525,1440750,2161125,3241650,4862475,7293700,10940550,16410825],max_levels:30,maxHP_increase:20,maxMP_increase:5,attack_increase:2,defense_increase:1}]}